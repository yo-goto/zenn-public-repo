---
title: "JSã®éžåŒæœŸå‡¦ç†ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«å¿…è¦ã ã£ãŸçŸ¥è­˜ã¨å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—"
emoji: "ðŸ¦„"
type: "idea"
topics: [javascript, éžåŒæœŸå‡¦ç†, ãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—, node, deno]
published: true
date: 2022-04-08
url: "https://zenn.dev/estra/articles/js-async-programming-roadmap"
aliases: [è¨˜äº‹_JSã®éžåŒæœŸå‡¦ç†ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«å¿…è¦ã ã£ãŸçŸ¥è­˜ã¨å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—]
tags: [" #type/zenn #JavaScript/async  "]
---

# ã¯ã˜ã‚ã«
JavaScript ã®éžåŒæœŸå‡¦ç†ã‚’å­¦ç¿’ã—ã¦ã¿ã¦ã€Œã‚ã‚‹ç¨‹åº¦è‡ªä¿¡ã‚’æŒã£ã¦ç†è§£ã§ããŸã¨è¨€ãˆã‚‹ã€çŠ¶æ…‹ã«åˆ°é”ã—ãŸã®ã§ã€ãã®æ„Ÿæƒ³ã¨ã€ã¾ã¨ã‚ã®å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—ã¨ãã®ä¸­ã§ã©ã®ã‚ˆã†ãªçŸ¥è­˜ãŒå¿…è¦ã«ãªã‚‹ã‹ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã“ã®è¨˜äº‹è‡ªä½“ã¯å¾Œã‹ã‚‰åˆ¥ã®è¨˜äº‹ã§å‚ç…§ã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€~~å…·ä½“çš„ãªè©±ã®ç„¡ã„æ°—è»½ãªå†…å®¹ãªã®ã§æµã—èª­ã¿ç¨‹åº¦ã«è¦‹ã¦ã‚‚ã‚‰ãˆã‚‹ã¨ã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“~~(éžåŒæœŸå‡¦ç†ã®å…·ä½“çš„ãªè©±ã‚‚å¾ŒåŠã‹ã‚‰ç››ã‚Šè¾¼ã¿ã¾ã—ãŸ)ã€‚ã‚ã‚‹ã„ã¯ã€è‡ªåˆ†ãŒå®Ÿéš›ã«å­¦ç¿’ã—ã¦ããŸé“ç­‹ã«åŸºã¥ã„ã¦ã„ã‚‹ã®ã§ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¨ã—ã¦å‚è€ƒã«ã—ã¦ã‚‚ã‚‰ã£ãŸã‚Šã€ä½¿ãˆã‚‹ãƒªã‚½ãƒ¼ã‚¹ãªã©ã®æƒ…å ±ãŒå…±æœ‰ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã‚‚ã—ãã¯ã€Œ**JavaScript åˆå¿ƒè€…ãŒéžåŒæœŸå‡¦ç†ã‚’ç†è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§ã®é“ç­‹**ã€ã¨ã„ã†ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã§ï¼‘ã¤ã®ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦è¦‹ã¦ã„ãŸã ã‘ã‚‹ã¨ã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã“ã®è¨˜äº‹è‡ªä½“ã«é–“é•ã„ã‚„ä¿®æ­£ã€æ›´æ–°ãŒã‚ã‚Œã°é©å®œä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚~~ã¾ãŸã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å­¦ç¿’ã‚’é€²ã‚ã¦ã„ã‚‹éƒ¨åˆ†ã‚‚ã‚ã‚‹ã®ã§çµæ§‹é »ç¹ã«æ›´æ–°ã—ã¦ã„ã¾ã™~~ã€‚éžåŒæœŸå‡¦ç†ã‚’äºˆæ¸¬ã™ã‚‹ãŸã‚ã®æœ¬è³ªçš„ãªéƒ¨åˆ†ã«åˆ°é”ã§ããŸã®ã§ã€ä¿®æ­£ä»¥å¤–ã®æ›´æ–°ã¯ãªã„ã¨æ€ã„ã¾ã™(å¤§ããªå‹˜é•ã„ãªã©ã‚’ã—ã¦ã„ãªã„é™ã‚Š)ã€‚

:::details ChangeLog
å¤§ããªå¤‰æ›´ã®ã¿ã‚’ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã—ã¦ã„ã¾ã™ã€‚
- 2022/04/30
  - ã€Œã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®å…±é€šæ€§è³ªã€ã®é …ç›®ã‚’è¿½åŠ 
  - ã€Œãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—ã®ã¾ã¨ã‚ã€ã®é …ç›®ã‚’è¿½åŠ 
- 2022-04-28
  - ã€ŒEvent loop ã¸ã®è§£åƒåº¦ã‚’ä¸Šã’ã‚‹ã€ã®é …ç›®ã‚’è¿½åŠ 
  - å…¨ä½“ã®é …ç›®ã‚’ä¿®æ­£ã—ã¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
  - ã€Œé›£ã—ã•ã®åŽŸå› ã€ã®é …ç›®ã‚’è¿½è¨˜
- 2022-04-17
  - ã€ŒãŠçŸ¥ã‚‰ã›ã€ã®é …ç›®ã‚’è¿½åŠ 
  - ã€Œè¿½è¨˜: éžåŒæœŸå‡¦ç†æ©Ÿèƒ½ã‚’ä¿¯çž°ã™ã‚‹ã€ã®é …ç›®ã‚’è¿½åŠ 
  - å†…å®¹ã®å¾®ä¿®æ­£
- 2022-04-14
  - ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®è£œè¶³ã‚’è¿½åŠ 
  - ã€Œç’°å¢ƒã€ã¨ã€ŒéžåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿ã€ã«é–¢ã—ã¦ã®ã¾ã¨ã‚ã‚’è¿½è¨˜
  - Web Workers ã«ã¤ã„ã¦ã®è¨˜è¿°ã‚’è¿½åŠ 
- 2022-04-13
  - ã€Œè¿½è¨˜: API ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ç’°å¢ƒã«ã¤ã„ã¦å­¦ã¶ã€ã®é …ç›®ã‚’è¿½åŠ 
  - Web APIs / Runtime APIs ã®é …ç›®ãŒæŠœã‘ã¦ã„ãŸã®ã§è¿½åŠ 
  - await å¼ã®è£œè¶³ã‚’è¿½åŠ 
:::

# ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ
éžåŒæœŸå‡¦ç†ã®å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—ãªã©ã¨éŠ˜æ‰“ã£ã¦è¨˜äº‹ã‚’æ›¸ã„ãŸã‹ã‚‰ã«ã¯ã€è‡ªåˆ†ã‚‚å…·ä½“çš„ãªéžåŒæœŸå‡¦ç†ã«ã¤ã„ã¦ã®è§£èª¬ã‚„ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’ã™ã¹ãã ã¨è€ƒãˆãŸã®ã§ã€ä¸»ã« Promise ãƒã‚§ãƒ¼ãƒ³ã«ã¤ã„ã¦ã®è§£èª¬ã‚’ã™ã‚‹ãŸã‚ã« Zenn ã® Book ã¨ã—ã¦ã€Œ**ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¨ãƒ—ãƒ­ãƒŸã‚¹ãƒã‚§ãƒ¼ãƒ³ã§å­¦ã¶JavaScriptã®éžåŒæœŸå‡¦ç†**ã€ã‚’å…¬é–‹ã—ã¾ã—ãŸã€‚

è‡ªåˆ†ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’å…¼ã­ã¦ãŠã‚Šã€å†…å®¹ã¨ã—ã¦ã¯è¨˜äº‹ã¨åŒè³ªãªã®ã§ç„¡æ–™å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚ç¾æ™‚ç‚¹ã§ã¯æœªå®Œæˆãªã®ã§è¿½è¨˜ä¿®æ­£ãŒé »ç¹ã«ã‚ã‚Šã¾ã™ãŒã€èˆˆå‘³ãŒã‚ã‚Œã°èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚

https://zenn.dev/estra/books/js-async-promise-chain-event-loop

# é›‘æ„Ÿ

:::message alert
ã“ã®é …ç›®ã¯å®Œå…¨ã«å€‹äººã®æ„è¦‹ã‚„æ„Ÿæƒ³ãªã®ã§é£›ã°ã—ã¦ã‚‚ã‚‰ã£ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚
:::

## éžåŒæœŸå‡¦ç†ã®æ„Ÿæƒ³
ã¾ãšéžåŒæœŸå‡¦ç†ã«ã¤ã„ã¦å­¦ã‚“ã§ã¿ã¦ã€ã€Œã‹ãªã‚Šé›£ã—ãã€å­¦ç¿’ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã€ã¨ã„ã†å°è±¡ã‚’å—ã‘ã¾ã—ãŸã€‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ã¯**å­¦ç¿’å‰äºˆæƒ³æ™‚ã®4å€**ã¯é›£ã—ã„ã§ã™(ï¼“å€ã‹ã‚‰ä¸Šæ–¹ä¿®æ­£ã—ã¾ã—ãŸ)ã€‚

éžåŒæœŸå‡¦ç†ãã®ã‚‚ã®ã«ã¤ã„ã¦ã¯"åˆ¶å¾¡ã®æµã‚Œ"ãŒæŽ´ã¿ã¥ã‚‰ãã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä½•ãŒèµ·ã“ã£ã¦ã„ã‚‹ã‹ã‚’æŠŠæ¡ã—ãªã„ã¨è‡ªåˆ†ã§æ›¸ã“ã†ã¨ã—ãŸã¨ãã«ã¾ã£ãŸãäºˆæ¸¬ãŒã§ãã¾ã›ã‚“ã€‚éžåŒæœŸå‡¦ç†ã®æµã‚Œè‡ªä½“ãŒæŽ´ã¿ã¥ã‚‰ã„ã®ã§ã€åŒæœŸå‡¦ç†ã¨éžåŒæœŸå‡¦ç†ãŒæ··ã˜ã£ã¦ã„ã‚‹ã¨ãã¯æ›´ã«äºˆæ¸¬ã—ãšã‚‰ããªã‚Šã¾ã™ã€‚åŠ ãˆã¦ã€éžåŒæœŸå‡¦ç†ã«ã¯ç¨®é¡žãŒã‚ã‚Šã€**ãã®ç¨®é¡žã”ã¨ã«å®Ÿè¡Œã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒå®Ÿã¯ç•°ãªã‚‹**ã®ã§ã€ãã‚Œã‚‰ãŒå…¥ã‚Šäº¤ã˜ã‚‹ã“ã¨ã§æ›´ã«äºˆæ¸¬ãŒé›£ã—ããªã£ã¦ã„ã¾ã™ã€‚

ãã‚‚ãã‚‚ã€ã€ŒåŒæœŸã€ã¨ã€ŒéžåŒæœŸã€ã¨ã„ã†è¨€è‘‰ã«é¨™ã•ã‚Œãã†ã«ãªã‚Šã¾ã™ã€‚

å±€æ‰€çš„ã«ã¯ Promise ã®æ¦‚å¿µãŒæŽ´ã¿ã¥ã‚‰ãã€ Promise ãƒã‚§ãƒ¼ãƒ³ã§ã¯ç‰¹ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ãŒã‚­ãƒ¼ã«ãªã‚‹ã®ã§ã™ãŒã€ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ã¶ã“ã¨ã§ã‚ˆã†ã‚„ãä½¿ãˆã‚‹ãƒ¬ãƒ™ãƒ«ã®ç†è§£ã«åˆ°é”ã§ããŸã¨æ„Ÿã˜ã¾ã—ãŸã€‚

ã¾ãŸã€async/await ã«ã¤ã„ã¦ã‚‚ã€ãã‚‚ãã‚‚ Promise ãƒã‚§ãƒ¼ãƒ³ã‚’ç†è§£ã—ã¦ã„ãªã„ã¨ä½¿ã„ç‰©ã«ãªã‚‰ãšã€**ãã®åå‰ã‹ã‚‰æ˜Žã‚‰ã‹ã«éžåŒæœŸå‡¦ç†ã®ä¸»å½¹ãªã®ã§ã¯ãªã„ã‹ã¨æ„Ÿã˜ã‚‰ã‚Œã‚‹**ä¸€æ–¹ã§ã€å®Ÿä½“ã¯ç•°ãªã‚‹ã®ã§ã€Œã“ã‚Œã¯é¨™ã•ã‚Œã‚‹ãªã€ã¨ã„ã†å°è±¡ã‚’å—ã‘ã¾ã—ãŸã€‚async/await ã¨ Promise ã®é–¢ä¿‚ãŒæŠŠæ¡ã§ãã¦ã„ãªã„ã¨è‡´å‘½çš„ã«æ··ä¹±ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚éžåŒæœŸé–¢æ•°ãŒ Promise ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ã€await å¼ãŒ Promise ã®è©•ä¾¡å€¤ã‚’è¿”ã—ã€**éžåŒæœŸé–¢æ•°å†…ã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã‚’åˆ†å‰²ã™ã‚‹ã“ã¨**ã€åŒæœŸå‡¦ç†ã¨éžåŒæœŸå‡¦ç†ã‚’è¡Œã£ãŸã‚ŠããŸã‚Šã™ã‚‹ã“ã¨ã€ãã‚Œã¨**é€æ¬¡çš„ã«å‡¦ç†ã‚’è¡Œã†**ã“ã¨ãªã©ã¨ã®é•ã„ãªã©ã€ã“ã“ã‚‰ã¸ã‚“ã§ã¯ãƒˆãƒ©ãƒƒãƒ—ã¨ãªã‚‹ãƒã‚¤ãƒ³ãƒˆãŒã„ãã¤ã‚‚ã‚ã‚Šã¾ã™ã€‚

ã€ŒPromise ã¨ã‹ await ã¨ã‹ã£ã¦ã¯å®Ÿã¯éžåŒæœŸå‡¦ç†ã§ã¯ãªã„ã®ã§ã¯ï¼ŸðŸ˜µâ€ðŸ’«ã€ã¨ã„ã†ã‚ˆã†ãªç–‘å•ãŒé€”ä¸­æ¹§ãä¸ŠãŒã£ãŸã‚Šã‚‚ã—ã¾ã™ãŒã€å€‹äººçš„ã«ã¯ãã®ç–‘å•ã‚’è§£æ¶ˆã™ã‚‹ã¨ã“ã‚ãŒã‚¿ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆã«ãªã‚‹ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚

åŸºæœ¬çš„ã«ã¯ã€è§£èª¬è¨˜äº‹ã‚’èª­ã‚“ã§ç†è§£ã—ãŸã¤ã‚‚ã‚Šã«ãªã£ã¦ã‚‚ã€åˆ¶å¾¡ã®æµã‚Œã‚’ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æƒ³åƒã—ã¦ã¿ãŸã‚Šã€å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã•ãªã„ã¨ç†è§£ã¯ã‹ãªã‚ŠåŽ³ã—ã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã ã‘ã§ç†è§£ã™ã‚‹ã®ã¯ã‹ãªã‚Šå›°é›£ãªã®ã§æ˜ åƒã‚„å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã“ã¨ã§æ¯”è¼ƒçš„ã¤ã‹ã¿ã‚„ã™ããªã‚Šã€å®Ÿéš›ã«ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å®Ÿè¡Œã—ã¦ã¿ã‚‹ã“ã¨ã§ç†è§£ã§ãã€ã ã‚“ã ã‚“ã¨åˆ¶å¾¡ã®æµã‚ŒãŒæŽ¨æ¸¬ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ãã¾ã™ã€‚

## é›£ã—ã•ã®åŽŸå›  (è¿½è¨˜)

ã“ã‚Œã¯**åˆå­¦è€…ã®è¦–ç‚¹ã‹ã‚‰ã®è©±**ã§ã™ãŒã€å¤šãã®éžåŒæœŸå‡¦ç†ã®è§£èª¬ã§ã¯ã€Œ**çœŸå®Ÿã§ã¯ã‚ã‚‹ãŒã€ç¾å®Ÿã®ã™ã¹ã¦ã‚’èªžã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„**ã€ã¨ã„ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå¤šãã€ãã‚Œã‚†ãˆã«éžåŒæœŸå‡¦ç†ã«ã¤ã„ã¦å‹˜é•ã„ã—ã¦ã—ã¾ã£ãŸã‚Šã€ã„ã¤ã¾ã§ã‚‚ç†è§£ã§ããªã„ã¨ã„ã†ç¾è±¡ãŒãŠããŒã¡ã ã¨æ„Ÿã˜ã¾ã—ãŸ(ã“ã‚Œã«ã¤ã„ã¦ã¯åˆå­¦è€…å‘ã‘ã®æƒ…å ±ã¨ã—ã¦ã®å´é¢ãŒã‚ã‚‹ã‹ã‚‰ã¨ã„ã†ç†ç”±ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“)ã€‚

:::message
ã‚‚ã¡ã‚ã‚“ã€ç¾å®Ÿã«èµ·ã“ã‚‹ã™ã¹ã¦ã®ã“ã¨ã‚’èªžã‚Œã°è‰¯ã„ã®ã‹ã¨ã„ã†è©±ã‚‚ã‚ã‚Šã¾ã™ãŒã€ãã‚Œã¯ãã‚Œã§å•é¡Œã§ã€ã„ããªã‚Šä»•æ§˜ã‚„å®Ÿè£…ã®è©±ã‚’ã•ã‚Œã¦ç†è§£ã™ã‚‹ã“ã¨ã¯éžå¸¸ã«å›°é›£ã§ã™ã€‚ã‚ã‚‹ãƒ¬ãƒ™ãƒ«ã¾ã§ã„ã‹ãªã„ã¨ä»•æ§˜ã‚„å®Ÿè£…ã®ã“ã¨ã¯ç†è§£ã§ãã¾ã›ã‚“ã€‚ãªã®ã§ã€é©åˆ‡ãªãƒ¬ãƒ™ãƒ«ã§ã®æŠ½è±¡åŒ–ã¨ã¡ã‚‡ã†ã©ã‚ˆã„å¡©æ¢…ã®æƒ…å ±ã®å–æ¨é¸æŠžã§ä¸€æœ¬ã®é“ç­‹ãŒåˆ†ã‹ã‚‹ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚‹ã¨è‰¯ã„ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚
:::

ä¾‹ãˆã°ã€ã€ŒJavaScript ã¯ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€ã¨ã„ã†å‘½é¡Œã¯çœŸã§ã™ãŒã€ç¾å®Ÿã«èµ·ã“ã‚‹ã“ã¨ã®ã™ã¹ã¦ã‚’èªžã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã§ã™ã€‚ã“ã®å‘½é¡Œã«å›ºåŸ·ã™ã‚‹ã¨éžåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿ã‚’ç†è§£ã§ãã¾ã›ã‚“ã€‚

é–¢é€£ã—ã¦ã€éžåŒæœŸå‡¦ç†ã¨ä¸¦åˆ—å‡¦ç†ã‚’æ··åŒã™ã‚‹ã®ã¯ã‚ã‚ŠãŒã¡ã§ã€ã€ŒéžåŒæœŸå‡¦ç†ã¯ä¸¦åˆ—å‡¦ç†ã§ã¯ãªã„ã€ã¨ã„ã†å‘½é¡Œã‚‚çœŸã§ã™ãŒã€ã“ã‚Œã«å›ºåŸ·ã™ã‚‹ã¨ã€Œå®Ÿè¡Œã—ãŸå‡¦ç†ã®å®Œäº†ã‚’å¾…ãŸãšã«æ¬¡ã®å‡¦ç†ã«è¡Œãã€ã‚‚ç†è§£ã§ããªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã€Œ**ã˜ã‚ƒã‚ã€ãã®å‡¦ç†ã¯ã©ã“ã§ã„ã¤å®Œäº†ã™ã‚‹ã‚“ã ?**ã€ã¨ã„ã†ç–‘å•ã‚’ã„ã ãã¾ã›ã‚“ã§ã—ãŸã‹ï¼Ÿ

ã“ã‚Œã¤ã„ã¦ã¯ã€å®Ÿéš›ã«ã¯ã€ŒAPI ã‚’ä»‹ã—ã¦ç’°å¢ƒã«å§”ä»»ã—ãŸä½œæ¥­ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä¸¦åˆ—ã«è¡Œã‚ã‚Œã€ãã‚ŒãŒå®Œäº†ã—ãŸã‚‰ä½•ã‹ã‚’ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§éžåŒæœŸçš„ã«è¡Œã†ã€ã¨ã„ã†ã‚ˆã†ãªä¸¡æ–¹ãŒçµ„ã¿åˆã‚ã•ã£ã¦èµ·ãã¦ã„ã‚‹ã¨ã„ã†ã‚ˆã†ã«è§£é‡ˆã‚’ã—ãªã„ã¨éžåŒæœŸå‡¦ç†ãã®ã‚‚ã®ã‚’è¡Œã†ç›®çš„ã«ã¤ã„ã¦æ··ä¹±ã™ã‚‹ã¯ã‚ã«ãªã‚Šã¾ã™ã€‚

ãã®ä»–ã«ã‚‚ã€ŒPromise ã¯åŒæœŸå‡¦ç†ã€ãªã©è¨€è‘‰ãŒä¸è¶³ã—ãŸæ–‡è¨€ãŒå­˜åœ¨ã—ã¦ãŠã‚Šã€ã€Œ`Promise()` ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿é–¢æ•°ã«æ¸¡ã™ `executor` é–¢æ•°ã¨ã„ã†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å‡¦ç†è‡ªä½“ã¯åŒæœŸçš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ãŒã€Promise ãƒã‚§ãƒ¼ãƒ³ã«ãŠã‘ã‚‹ `then()` ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯éžåŒæœŸçš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ã€ã¨ã„ã£ãŸã‚ˆã†ã«ç•°ãªã‚‹ï¼’ã¤ã®æƒ…å ±ã‚’å¯¾æ¯”ã•ã›ãªã„ã¨èª¤è§£ã—ãŸã‚Šæ··ä¹±ã—ãŸã‚Šã—ãŒã¡ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚å¤šãã‚ã‚‹ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚

ã‚‚ã†ï¼‘ã¤ã€é›£ã—ã•ã®åŽŸå› ã¨ã—ã¦è€ƒãˆã‚‰ã‚Œã‚‹ã®ã¯ã€Œ**å­¦ç¿’ã®ãƒãƒ¼ãƒ‰ãƒ«è‡ªä½“ãŒéžå¸¸ã«é«˜ã„ã“ã¨**ã€ã§ã™ã€‚

JavaScript ã®éžåŒæœŸå‡¦ç†ã«ã¤ã„ã¦ã¯ãã®é›£ã—ã•ã®æ€§è³ªã¨å¿…è¦ãªæƒ…å ±é‡ã®å¤šã•ã®ãŸã‚ã«ã€**è‰²ã€…ãªãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰æ–­ç‰‡çš„ãªæƒ…å ±ã‚’æ‹¾ã„é›†ã‚ã¦ç¹‹ã„ã§ã„ãå¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚ã“ã®ä½œæ¥­ãŒéžåŒæœŸå‡¦ç†ã«ã¤ã„ã¦ã¯æ ¼æ®µã«å¤šãã€ã»ã¨ã‚“ã©ã¯è‹±èªžã®æƒ…å ±ã‹ã‚‰ã‹ãé›†ã‚ã¦ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è¿½è¨˜ã®é …ç›®ã§ã‚‚æ›¸ãã¾ã—ãŸãŒã€éžåŒæœŸå‡¦ç†ã®è©±é¡Œã§ç›®ã«ã¤ãã‚ˆã†ãª Promise ã‚„ async/await ã¨ã„ã£ãŸè¨€èªžã®æ©Ÿèƒ½ã ã‘ã§ã¯**ã©ã†ã‚ãŒã„ã¦ã‚‚ç†è§£ã§ããªã„ä»•çµ„ã¿**ã«ãªã£ã¦ãŠã‚Šã€ãã®ã“ã¨ã«ã¤ã„ã¦è§¦ã‚Œã‚‰ã‚Œã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚‚ãã“ã¾ã§å¤šããªã„ã®ã§ã€ã€Œç†è§£ã§ãã¦ã„ã‚‹ã‚ˆã†ã§å®Ÿã¯ã¾ã£ãŸãç†è§£ã§ãã¦ã„ãªã„ã€çŠ¶æ…‹ã«ãªã‚‹å¯èƒ½æ€§ãŒéžå¸¸ã«é«˜ã„ã§ã™ã€‚è¨€èªžæ©Ÿèƒ½ã®ã¿ã‚’è¦‹ã¦ã„ã¦ã‚‚ã€æƒ…å ±ãŒä¸è¶³ã—ã™ãŽã¦ã„ã¦ä½•ã‚’ç†è§£ã—ã¦ã„ãªã„ã‹ãŒåˆ†ã‹ã‚‰ãªã„ã®ã§ã€ã©ã“ã¾ã§ã„ã£ã¦ã‚‚éžåŒæœŸå‡¦ç†ãŒç†è§£ã§ããªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã€Œä»•æ§˜ã‚’è¦‹ã‚Œã°ã‚ˆã„ã®ã§ã¯?ã€ã¨ã„ã†çµè«–ã«è‡³ã‚‹ã‚ã‘ã§ã™ãŒã€åˆå¿ƒè€…ã§åˆ¶å¾¡äºˆæ¸¬ãŒã§ãã‚‹ç¨‹åº¦ã®éžåŒæœŸå‡¦ç†ã®åŸºç¤Žã‚’ç†è§£ã™ã‚‹ã®ã«æœ€åˆã‹ã‚‰ã€Œä»•æ§˜ã€ã‚’è¦‹ã‚ˆã†ã¨æ€ã†äººã‚‚èª­ã¿ã¨ã‘ã‚‹äººã‚‚ã»ã¨ã‚“ã©ã„ã¾ã›ã‚“ã€‚ã—ã‹ã‚‚ã€JavaScript ã®éžåŒæœŸå‡¦ç†ã«é–¢ã‚ã‚‹ Event loop ãªã©ã®ä»•æ§˜ã¯ ECMAScript ã«ã¯ãªãåˆ¥ã®ã¨ã“ã‚ã«ã‚ã‚‹ã‚ã‘ã§ã™ã‹ã‚‰(ã—ã‹ã‚‚ãƒ–ãƒ©ã‚¦ã‚¶ã¨ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒã§ãã‚Œãžã‚Œç•°ãªã‚‹)ã€æœ¬æ°—ã§ç†è§£ã—ã‚ˆã†ã¨æ€ã£ã¦èª¿ã¹ãªã„ã¨åˆ°é”ã§ããªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

:::message alert
ãã‚‚ãã‚‚ã€éžåŒæœŸå‡¦ç†ã®åˆ¶å¾¡ã‚’äºˆæ¸¬ã™ã‚‹ã“ã¨ãŒåŸºç¤Žã§ã¯ãªãã€ã‹ãªã‚Šé›£ã—ã„å¿œç”¨ãªã®ã§ã¯ãªã„ã‹ã¨ä»Šæ›´ãªãŒã‚‰æ€ã†ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚å®Ÿéš›ã€å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè¡Œãƒ¬ãƒ™ãƒ«ãªã‚‰åˆ¶å¾¡äºˆæ¸¬ã¯ãªã‚“ã¨ã‹ã§ãã¦ã‚‚ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå…¥ã£ã¦ããŸæ™‚ç‚¹ã§ç›¸å½“ã«é›£ã—ããªã‚‹ã“ã¨ã¯äºˆæƒ³ãŒä»˜ãã¾ã™ã€‚ã§ã™ãŒã€å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã™ã‚‰å®Ÿè¡Œäºˆæ¸¬ãŒã§ããªã‘ã‚Œã°ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®äºˆæ¸¬ãŒã¾ã£ãŸãã¤ã‹ãªã„ã®ã§ã€ã‚„ã¯ã‚Šã‚ã‚‹ç¨‹åº¦ã¯å¿…ãšäºˆæ¸¬ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ãŒåŸºç¤Žãªã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
:::

# å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—

## ECMAScript ã®åŸºæœ¬ã‚’å­¦ç¿’
éžåŒæœŸå‡¦ç†ã¨ã„ã†ã‚«ãƒ†ã‚´ãƒªã«ã¤ã„ã¦ã¯(ãã‚‚ãã‚‚ JavaScript ã¯)ã€å¤šãã®æœ‰ç”¨ãªãƒªã‚½ãƒ¼ã‚¹ãŒã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§æœ€å¤§é™ãã‚Œã‚‰ã‚’æ´»ç”¨ã—ã¦å­¦ç¿’ã‚’ã™ã™ã‚ã¦ã„ãã¾ã™ã€‚

ã¾ãšã¯éžåŒæœŸå‡¦ç†ã®å‰ã«å¤–ã™ã“ã¨ã®ã§ããªã„å¿…è¦ãªçŸ¥è­˜ã¨ã—ã¦ä»¥ä¸‹ã®äº‹æŸ„ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
- å¼(Expression)
- é–¢æ•°å¼
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
- ç„¡åé–¢æ•°
- ã‚¢ãƒ­ãƒ¼é–¢æ•°ã¨çœç•¥å½¢
- å³æ™‚å®Ÿè¡Œé–¢æ•°

ã“ã®ã‚ãŸã‚Šã®çŸ¥è­˜ãŒä»–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„è§£èª¬ã‚’è¦‹ã‚‹æ™‚ã«**æš—é»™çš„ã«å¿…è¦**ã«ãªã£ã¦ãã¾ã™ã€‚ç‰¹ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã¨ã‚¢ãƒ­ãƒ¼é–¢æ•°ã¯é‡è¦ã§ã™ã€‚async function ã‚’ä½¿ç”¨ã™ã‚‹éš›ã«ã¯å³æ™‚å®Ÿè¡Œé–¢æ•°ãŒã‚ˆãã§ã¦ãã¾ã™ã€‚await ã‚’ç†è§£ã™ã‚‹éš›ã«ã‚‚å¼ã®æ¦‚å¿µãŒã‚­ãƒ¼ã¨ãªã‚‹ã®ã§é‡è¦ã§ã™ã€‚éžåŒæœŸå‡¦ç†ã¯ JavaScript ã®ä¸­ã§ã‚‚æ¯”è¼ƒçš„é«˜åº¦ãªå†…å®¹ã§ã‚ã‚Šã€ã“ã†ã„ã£ãŸçŸ¥è­˜ãŒå‰æã¨ã•ã‚ŒãŸçŠ¶æ…‹ã§è©±ãŒé€²ã‚“ã§ã„ãã¾ã™ã®ã§ç†è§£ã—ã¦ãŠãã®ã‚’æŽ¨å¥¨ã—ã¾ã™ã€‚

ä¸å®‰ãŒã‚ã‚‹å ´åˆã«ã¯ã€azu æ°ã® "JavaScript Primer" ã§ã€Œå¼ã¨æ–‡ã€ã¨ã€Œé–¢æ•°ã€ã®é …ç›®ã‚’èª­ã‚“ã§ãŠãã®ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

https://jsprimer.net/basic/statement-expression/

https://jsprimer.net/basic/function-declaration/

ä»¥ä¸ŠãŒç†è§£ã§ãã¦ã„ã‚‹ãªã‚‰ã€ã¾ãšã€ŒéžåŒæœŸå‡¦ç†ã®åŸºç¤Žã€ã‚’ä¸€ã‹ã‚‰å­¦ã¶ãŸã‚ã« "JavaScript Primer" ã®æ¬¡ã®é …ç›®ã‚’èª­ã¿ã™ã™ã‚ã¾ã—ã‚‡ã†(ãŸã ã—ã€ã„ããªã‚Šã™ã¹ã¦ç†è§£ã—ã‚ˆã†ã¨ã™ã‚‹ã®ã¯å›°é›£ãªã®ã§ã‚ã‚‹ç¨‹åº¦ã®ç†è§£åº¦ã§æœ€å¾Œã¾ã§é€²ã‚ã¦ã„ãã€ç´°ã‹ã„ç‚¹ã«ã¤ã„ã¦ã¯å¾Œã‹ã‚‰å‚ç…§ã—ã¦ã„ãå½¢ãŒã‚ˆã„ã¨æ€ã„ã¾ã™)ã€‚"JavaScript Primer" ã§ã¯ã€ã€ŒJavaScript ã®éžåŒæœŸå‡¦ç†ã®æ­´å²çš„ãªç™ºå±•ã€ãŒä¿¯çž°ã§ãã€ã‚¨ãƒ©ãƒ¼ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ â†’ Promise â†’ async/await ã¨ã„ã†ã‚ˆã†ã«é †ã‚’è¿½ã£ã¦éžåŒæœŸå‡¦ç†ã®å¿…è¦ãªçŸ¥è­˜ãŒä¸€é€šã‚Šå­¦ç¿’ã§ãã¾ã™ã€‚

https://jsprimer.net/basic/async/

https://jsprimer.net/use-case/ajaxapp/

:::message
ã¡ãªã¿ã«ã€è‡ªåˆ†ãŒéžåŒæœŸå‡¦ç†ã‚’ã€Œæœ¬æ ¼çš„ã«ã€å­¦ç¿’ã—ã¯ã˜ã‚ãŸã®ã¯ JavaScript Primer ã‚’ã»ã¼èª­ç ´ã—ãŸå¾Œã§ã‚ã‚Šã€ä¸Šã§æŒ™ã’ãŸå‰æã¨ãªã‚‹çŸ¥è­˜ã‚„éžåŒæœŸå‡¦ç†ã®å°Žå…¥ã¯ JavaScript Primer ã‚’èª­ã‚“ã§æ—¢ã«å®Œäº†æ¸ˆã¿ã¨ã„ã†å‰æãŒã‚ã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã“ã‚Œä»¥é™ã®è©±ã¯ã€ãã†ã„ã£ãŸåŸºç¤Žã«ã¤ã„ã¦ã¯ç†è§£ã§ããŸãŒ(ç†è§£ã§ããŸã¨æ€ã£ã¦ã„ãŸãŒ)ã€å®Ÿéš›ã«éžåŒæœŸå‡¦ç†ã‚’æ›¸ã„ãŸã‚Šã€äººã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã ã‚Šã—ã‚ˆã†ã¨ã—ãŸéš›ã«ã€Œ**æ›¸ã‘ãªã„ãƒ»èª­ã‚ãªã„ãƒ»åˆ†ã‹ã‚‰ãªã„**ã€ã¨ã„ã†çŠ¶æ³ã«é™¥ã£ãŸãŸã‚ã«ã•ã‚‰ãªã‚‹ç†è§£ã‚’æ±‚ã‚ã¦å­¦ç¿’ã—ãŸå†…å®¹ã¨ãªã‚Šã¾ã™ã€‚
:::

## åˆ¶å¾¡äºˆæ¸¬ã®ãŸã‚ã®åŸºç¤ŽçŸ¥è­˜ã‚’å­¦ã¶

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿çµ‚ãˆã¦ã€Œå®Œå…¨ã«ç†è§£ã—ãŸã€ã¨æ€ã£ã¦ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿéš›ã«æ›¸ã“ã†ã¨ã—ã¦ã‚‚(éžåŒæœŸå‡¦ç†ã®åˆ¶å¾¡ãŒäºˆæ¸¬ã§ããš)ã‹ã‘ãªã„ã“ã¨ã«æ°—ã¥ãã®ã§æ¬¡ã«éžåŒæœŸå‡¦ç†ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®å‹•ãã‚’å­¦ç¿’ã—ã¾ã™ã€‚

ã¾ãšã¯éžåŒæœŸå‡¦ç†ã®æµã‚Œã‚’ç†è§£ã™ã‚‹ã®ã«å¿…è¦ãªç”¨èªžçŸ¥è­˜ã‚’ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚
- concurrent(ä¸¦è¡Œ)/parallel(ä¸¦åˆ—)
- asynchronous(éžåŒæœŸ)/synchronous(åŒæœŸ)
- sequential(é€æ¬¡çš„)
- blocking/non-blocking
- single-thread/multi-thread
- Node.js ã‚„ V8 engine ã«ã¤ã„ã¦ã®åŸºç¤ŽçŸ¥è­˜

ä¸Šè¨˜ã®å˜èªžã«ã¤ã„ã¦ã¯ã€ã“ã“ã¾ã§ãã‚Œã°ã‚ã‚‹ç¨‹åº¦ã®è§£åƒåº¦ã§ç†è§£ã§ãã¦ã„ã‚‹ã¯ãšã§ã™ãŒã€ã„ã‚ã‚“ãªè¨˜äº‹ã‚’è¦‹ã¦ã‚‚ã“ã“ã‚‰ã¸ã‚“ã®è¨€è‘‰ã£ã¦å‰²ã¨å®šç¾©ãŒã‚ã„ã¾ã„ãªã®ã§ã€ãªã‚‹ã¹ãè§£åƒåº¦ã‚’ã‚ã’ã¦ãŠãã¨ã‚ˆã„ã¨æ€ã„ã¾ã™ã€‚å¤šåˆ† "synchronous" ã«æŒ¯ã‚Šå›žã•ã‚Œã‚‹ã®ã§ã€"sequential" ã¨ "blocking" ã‚’æ„è­˜ã§ãã‚‹ã‚ˆã†ã«æ³¨è¦–ã—ã¦ãŠãã¨è‰¯ã„ã¨æ€ã„ã¾ã™(è‡ªåˆ†ã¯é€”ä¸­ã§ã€ŒåŒæœŸçš„ã€ã¨ã„ã†æ¦‚å¿µãŒåˆ†ã‹ã‚‰ãªããªã‚Šéžå¸¸ã«æ··ä¹±ã—ã¾ã—ãŸ)ã€‚

blocking/non-blocking ã«ã¤ã„ã¦ã¯ Node.js å…¬å¼ã‚µã‚¤ãƒˆã®æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’ä¸€èª­ã—ã¦ãŠãã¨ç†è§£ãŒé€²ã¿ã¾ã™ã€‚

https://nodejs.org/ja/docs/guides/blocking-vs-non-blocking/

blocking ã®ä¾‹ã¨ã—ã¦ Node.js ã®åŒæœŸ API (Synchronous API) ã«ã¤ã„ã¦ã‚‚çŸ¥ã£ã¦ãŠãã¨ã‚ˆã„ã§ã™ã€‚åŒæœŸ API ã¯ Node.js ã® Event loop ã¨å¾Œç¶šã® JavaScript ã®å‡¦ç†ã‚’ã€ãã® API ã®å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã® API ã¯ `readFileSync` ãªã©åå‰ã®æœ€å¾ŒãŒ `Sync` ã§çµ‚ã‚ã‚Šã¾ã™ã€‚

æ¬¡ã«éžåŒæœŸå‡¦ç†ã®æµã‚Œã‚’äºˆæ¸¬ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ãŸã‚å¿…è¦ãªçŸ¥è­˜ã¨é“å…·ã‚’ç²å¾—ã—ã¾ã™ã€‚
- Event Loop
- Call Stack
- Heap
- **Web APIs** / Runtime APIs
- Microtask ã¨ Microtask Queue
- Macrotask ã¨ Macrotask Queue

ã“ã‚Œã‚‰ã®ç”¨èªžã¯éžåŒæœŸå‡¦ç†ã®ç¨®é¡žã‚’èªè­˜ã—ã¦ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®æµã‚Œã‚’ã‚ã‚‹ç¨‹åº¦ã®è§£åƒåº¦ã§ç†è§£ã™ã‚‹ã®ã«å¿…è¦ã«ãªã£ã¦ãã¾ã™ã€‚éžåŒæœŸå‡¦ç†ã®æµã‚Œ(å®Ÿè¡Œé †ç•ª)ã‚’æŠŠæ¡ãƒ»äºˆæ¸¬ã™ã‚‹ãŸã‚ã«ã¯å¿…ãšç†è§£ã—ãŸã»ã†ãŒã‚ˆã„ã§ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¢ã‚¤ãƒ†ãƒ ç„¡ã—ã§ã¯é€²ã‚€ã“ã¨ãŒã§ãã¾ã›ã‚“(Event loop ãªã—ã§éžåŒæœŸå‡¦ç†ã‚’ç†è§£ã™ã‚‹ã®ã¯**ä¸å¯èƒ½**ã¨è¨€ã£ã¦ã‚‚éŽè¨€ã§ã¯ãªã„ã§ã™)ã€‚

ã¾ãšã€Call Stack ã¨ Event Loop ã‚’ç†è§£ã™ã‚‹ãŸã‚ã« JSConf EU ã§ã® Philip Roberts æ°ã®è¬›æ¼”å‹•ç”»ã€ŒWhat the heck is the event loop anyway?ã€ã‚’è¦‹ã‚‹ã“ã¨ã‚’å¼·ãã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ã€‚

@[youtube](8aGhZQkoFbQ)

ã“ã®å‹•ç”»ã¯å¤šãã®äººãŒã‚ªã‚¹ã‚¹ãƒ¡ã—ãŸã‚Šã€æ§˜ã€…ãªè¨˜äº‹ã§å¼•ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚éžå¸¸ã«åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜Žã•ã‚Œã¦ãŠã‚Šã€éžåŒæœŸå‡¦ç†ã®ç‰‡æ–¹(Macrotask)ã‚’ç†è§£ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚2014 å¹´ã®å‹•ç”»ã§ã™ãŒã€JSConf ã®å‹•ç”»ã¯ä»–ã«ã‚‚ã„ãã¤ã‹è¦‹ã¾ã—ãŸãŒã€~~ã“ã®å‹•ç”»ä»¥ä¸Šã«åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜Žã—ã¦ã„ã‚‹ã‚‚ã®ã¯ã‚ã‚Šã¾ã›ã‚“~~ã€‚

è¿½è¨˜:ã€ŒWhat the heck is the event loop anyway?ã€ã¯ Event loop ã¨éžåŒæœŸå‡¦ç†ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®**å…¥ã‚Šå£ã¨ãªã‚‹å‹•ç”»**ã¨ã—ã¦éžå¸¸ã«ç´ æ™´ã‚‰ã—ã„ã®ã§ã™ãŒã€JSConf ã§ã®ä»–ã®é–¢é€£ã™ã‚‹å‹•ç”»ã‚‚ã“ã®å‹•ç”»ã¨åŒã˜ã‹ãã‚Œä»¥ä¸Šã«è¦–è´ã™ã‚‹ä¾¡å€¤ãŒã‚ã‚‹ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸã€‚ã“ã®ç‚¹ã«ã¤ã„ã¦ã¯è¿½è¨˜ã®é …ç›®ã§è¨˜è¼‰ã—ã¾ã™ã€‚

:::message
Chrome ãªã©ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã¨ Node.js ã‚„ Deno ã®ç’°å¢ƒã§ã¯ JavaScript ã‚¨ãƒ³ã‚¸ãƒ³ã¨ã—ã¦åŒã˜ V8 ã‚¨ãƒ³ã‚¸ãƒ³ã‚’æŽ¡ç”¨ã—ã¦ã¾ã™ãŒã€Event Loop ã®å®Ÿè£…ã¯ãã‚Œãžã‚Œé•ã„ã¾ã™ã€‚ãã‚Œãžã‚Œã®ç’°å¢ƒã§ Event loop ã‚’å®Ÿè£…ã™ã‚‹ã®ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä»¥ä¸‹ã®ã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚

- [Libevent](https://libevent.org) (Chrome): an event notification library
- [Libuv](https://libuv.org) (Node.js) : a multi-platform support library with a focus on asynchronous I/O
- [Tokio](https://tokio.rs) (Deno) : an asynchronous Rust runtime 

V8 ã‚¨ãƒ³ã‚¸ãƒ³ãŒæ‹…å½“ã—ã¦ã„ã‚‹ã®ã¯ã€Heap ã¨ Call Stack ã§ã™ã€‚V8 ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã¯ setTimeout ã‚„ DOMã€HTTP request ã¨ã„ã£ãŸ Web APIs ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

ä¸Šè¨˜ã®å‹•ç”»ã§è§£èª¬ã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã® Event Loop ã§ã™ã€‚Promise ãƒã‚§ãƒ¼ãƒ³ã‚„ async/await ã¨ã„ã£ãŸè¨€èªžã¨ã—ã¦ã®éžåŒæœŸå‡¦ç†ã‚’ç†è§£ã™ã‚‹ãƒ¬ãƒ™ãƒ«ã§ã®æŠ½è±¡åŒ–ãªã‚‰ã€Node.js ã§ã‚‚ Deno ã§ã‚‚åŒã˜ã‚ˆã†ã«è€ƒãˆã¦å¤§ä¸ˆå¤«ã§ã™(ã‚‚ã¡ã‚ã‚“é–‹ç™ºãƒ¬ãƒ™ãƒ«ã§å¿…è¦ãªã‚‰ I/O ã¨ã‹ã‚¿ã‚¤ãƒžãƒ¼ã®æŒ¯ã‚‹èˆžã„ã¯é•ã†å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§å…·ä½“çš„ã«çŸ¥ã‚‹å¿…è¦ã¯ã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒ)ã€‚ãŸã ã—ã€Web APIs ã®éƒ¨åˆ†ã¯ãƒ–ãƒ©ã‚¦ã‚¶ç‰¹æœ‰ã®ã‚‚ã®ãªã®ã§ã€Node.js ã‚„ Deno ã§ã¯ãã‚Œã«å¯¾å¿œã™ã‚‹ã‚‚ã®ã¨ã—ã¦ Runtime APIs ã§ç½®ãæ›ãˆã¦è€ƒãˆã¾ã™ã€‚
:::

å‹•ç”»ã§æ¦‚è¦ã‚’ç†è§£ã—ãŸã‚‰åŒæ°ãŒé–‹ç™ºã—ãŸ JavaScript ã®å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ "Loupe" ã§å®Ÿéš›ã« `setTimeout()` é–¢æ•°ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚„ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãªã©ãŒã©ã®ã‚ˆã†ã«å‹•ãã‹å®Ÿé¨“ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

http://latentflip.com/loupe/

![js loupe image](/images/js-async/img_loupe-js-async.jpg)

Loupe ã§ã¯ï¼’ç¨®é¡žã‚ã‚‹éžåŒæœŸå‡¦ç†ã®ç¨®é¡žã®å†…ã®ï¼‘ã¤(Macrotask: ãƒžã‚¯ãƒ­ã‚¿ã‚¹ã‚¯)ã—ã‹ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã®ã§ã€æ¬¡ã« Github ç¤¾ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã‚ã‚‹ Andrew Dillon æ°ãŒé–‹ç™ºã—ãŸ "JavaScript Visualizer 9000" ã‚’ä½¿ç”¨ã—ã¦ Promise é–¢é€£ã®éžåŒæœŸå‡¦ç†(Microtask: ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯)ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚

https://www.jsv9000.app

JavaScript Visualizer 9000 ã§ã¯ã‚µãƒ³ãƒ—ãƒ«ãŒã„ãã¤ã‚‚ç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€ãã‚Œã‚‰ã‚’ç†è§£ã™ã‚‹ã ã‘ã§ã‚‚éžå¸¸ã«æœ‰ç”¨ã§ã™ã€‚äºŒç¨®é¡žã®éžåŒæœŸå‡¦ç†ã«ã¤ã„ã¦ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã®ã§è‡ªåˆ†ãŒæ›¸ã„ã¦ã¿ãŸéžåŒæœŸå‡¦ç†ã‚’å®Ÿéš›ã«ã“ã®ã‚¢ãƒ—ãƒªã§å®Ÿè¡Œã—ã¦ã¿ã¦éžåŒæœŸå‡¦ç†ã®æµã‚ŒãŒäºˆæ¸¬ã©ãŠã‚Šã‹ç¢ºèªã—ã¦ã„ãã“ã¨ã§éžåŒæœŸå‡¦ç†ã®æµã‚ŒãŒèª­ã‚ã‚‹ã‚ˆã†ã«ãªã£ã¦ãã¾ã™ã€‚ãŸã ã—ã€async/await ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã®ã§ã™ãã“ã¯æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

![js visualizer 9000](/images/js-async/img_js-visualizer-9000.jpg)

JavaScript Visualizer 9000 ã‚’ä½¿ã£ã¦ã€Macrotask ã¨ Micortask ã®çµ„ã¿åˆã‚ã›ã«æ…£ã‚Œã¦ãã ã•ã„ã€‚ã“ã“ã§ã¯é‡è¦ãªã“ã¨ã¨ã—ã¦ã€ ~~Macrotask Queue (Task Queue) ã¯å®Ÿã¯**ã‚­ãƒ¥ãƒ¼ã§ã¯ãªãã‚»ãƒƒãƒˆ**ã§ã‚ã‚‹ã“ã¨ã‚’ç†è§£ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è¤‡æ•°ã® `setTimeout()` é–¢æ•°ã‚’è‰²ã€…ãª delay æ™‚é–“ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œã—ã¦ã¿ã‚Œã°ç†è§£ã§ãã¾ã™ãŒã€ã‚ãã‚‰ã‹ã«ã‚­ãƒ¥ãƒ¼ã§ã¯ãªã„ã§ã™ã€‚ã‚»ãƒƒãƒˆã§ã‚ã‚‹ã¨ã„ã†ã®ã‚‚ã€ãã‚‚ãã‚‚ä»•æ§˜ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™~~ã€‚(å®Œå…¨ãªé–“é•ã„)

https://html.spec.whatwg.org/multipage/webappapis.html#task-queue

>Task queues are sets, not queues, because step one of the event loop processing model grabs the first runnable task from the chosen queue, instead of dequeuing the first task.  
>(ä¸Šè¨˜ãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨)

è¿½è¨˜: ã“ã‚Œã¯ã€ã€ŒTask queues(ã¨ã„ã†é›†åˆ)ã¯ãŸã ã®ã‚­ãƒ¥ãƒ¼ã®é›†åˆã§ã¯ãªãã€ã‚»ãƒƒãƒˆã§ã‚ã‚‹ã€ã¨ã„ã†ã“ã¨ã‚’æ„å‘³ã—ã¦ã„ã¦ã€å˜ä¸€ã® "Task queue" ã¯åå‰ã®é€šã‚Šã‚­ãƒ¥ãƒ¼ã§ã‚ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚å®Ÿã¯ã“ã‚Œéžå¸¸ã«é‡è¦ãªäº‹æŸ„ã§ã—ãŸã€‚

ã¨ã«ã‹ãã€JavaScript Visualizer 9000 ã¯éžåŒæœŸå‡¦ç†ã‚’ç†è§£ã™ã‚‹ã¾ã§é•·ã„ä»˜ãåˆã„ã«ãªã£ãŸã®ã§éžå¸¸ã«ã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã€‚ã“ã‚ŒãŒç„¡ã‹ã£ãŸã‚‰éžåŒæœŸå‡¦ç†ã‚’ç†è§£ã§ããªã‹ã£ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

:::message alert
JavaScript Visualizer 9000 ã‚’ä½¿ã£ã¦å¯è¦–åŒ–ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚„ãƒžã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒ Call stack ã¨ Event Loop ã§ã©ã†å‹•ãã‹ã‚’äºˆæ¸¬ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ãŒã€JavaScript Visualizer 9000 ã§ã¯ Web APIs ã®è¦ç´ ãŒç„¡ã„ãŸã‚ã€å®Ÿã¯ã‚‚ã†ä¸€æ­©è¸ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãªãœ **Web APIs** ã®è¦ç´ ã‚’çœã„ãŸã®ã‹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚å®Ÿã¯ã“ã‚ŒãŒçœç•¥ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã«ã€Visualizer 9000 ã§è¤‡æ•°ã® `setTimeout()` é–¢æ•°ã‚’è‰²ã€…ãª delay æ™‚é–“ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œã—ã¦ãƒžã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®å‹•ãã‚’è¦‹ã‚‹ã¨ã€Œã‚­ãƒ¥ãƒ¼ã€ã¨æ€ãˆãªã„æŒ™å‹•ã«è¦‹ãˆã¦ã—ã¾ã†ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸã€‚åŸºæœ¬çš„ãªæµã‚Œã‚’ç†è§£ã™ã‚‹ã®ã«ã¯å•é¡Œãªã„ã§ã™ãŒã€æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

Visualizer 9000 ã§ã¯ç°¡å˜ã«ã‚³ãƒ¼ãƒ‰ãŒå…±æœ‰ã§ãã‚‹ã®ã§å®Ÿéš›ã«ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å®Ÿè¡Œã—ã¦æŒ™å‹•ã‚’è¦‹ã¦ã¿ã¦ãã ã•ã„â†“
[manySetTimeout.js](https://www.jsv9000.app/?code=Ly8gbWFueVNldFRpbWVvdXQuanMKc2V0VGltZW91dChmdW5jdGlvbiBiKCkgewogIGNvbnNvbGUubG9nKCJiOiBhZnRlciA1MDBtcyIpOwp9LCA1MDApOwpzZXRUaW1lb3V0KGZ1bmN0aW9uIGMoKSB7CiAgY29uc29sZS5sb2coImM6IGFmdGVyIDBtcyIpOwp9LCAwKTsKc2V0VGltZW91dChmdW5jdGlvbiBhKCkgewogIGNvbnNvbGUubG9nKCJhOiBhZnRlciAxMDAwbXMiKTsKfSwgMTAwMCk7CnNldFRpbWVvdXQoZnVuY3Rpb24gZCgpIHsKICBjb25zb2xlLmxvZygiZDogYWZ0ZXIgMTAwbXMiKTsKfSwgMTAwKTsKCmZ1bmN0aW9uIGQoKSB7CiAgY29uc29sZS5sb2coImQ6IHN5bmMgZnVuY3Rpb24gZXhlY3V0ZWQgaW1tZWRpYXRlbHkiKTsKfQoKZCgpOwo%3D)
:::

## Promise ãƒã‚§ãƒ¼ãƒ³ã®æ§‹ç¯‰ã®ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ã¶
ã•ã¦ã€ã“ã“ã¾ã§ãã‚Œã°éžåŒæœŸå‡¦ç†ãŒã‹ãªã‚Šç†è§£ã§ãã¦ã„ã‚‹ã¯ãšã§ã™ã€‚ãã£ã¨ã€ŒéžåŒæœŸå‡¦ç†ã€å®Œå…¨ã«ç†è§£ã—ãŸðŸ˜¼ã€çŠ¶æ…‹ã§ã™ã­ã€‚
ã§ã¯ã€ãƒ†ã‚¹ãƒˆã¨ã—ã¦ã‚„ã£ã™ã‚“æ°ã®æ¬¡ã®å‹•ç”»ã§ã‚¯ã‚¤ã‚ºã‚’ã¨ã„ã¦ã¿ã¦ãã ã•ã„ã€‚

@[youtube](T-_0Pc5P12U)

ã„ã‹ã‹ã§ã™ã‹?
è‡ªåˆ†ã®å ´åˆã¯ã€Œä¿ºã€Promise ã¨ã‹ async/await ã®ã“ã¨å…¨ç„¶ã‚ã‹ã£ã¦ã­ãˆã˜ã‚ƒã‚“...ðŸ˜­ã€ã¨ãªã‚Šã¾ã—ãŸã€‚

å‹•ç”»ã‚’ã¿ã¦ã‚‚ã‚‰ã£ãŸã‚‰åˆ†ã‹ã‚‹ã¨æ€ã†ã®ã§ã™ãŒã€Promise ã¨ `await` å¼ã®é–¢ä¿‚ãŒåˆ†ã‹ã£ã¦ã„ãªã„ã¨ 1 ç•ªç›®ã¨ 2 ç•ªç›®ã®ã‚¯ã‚¤ã‚ºãŒè§£ã‘ã¾ã›ã‚“ã—ã€ãã—ã¦ Promise ãƒã‚§ãƒ¼ãƒ³ãŒç†è§£ã§ãã¦ã„ãªã„ã¨æœ€å¾Œã®ã‚¯ã‚¤ã‚ºãŒã¨ã‘ã¾ã›ã‚“ã€‚

ãªã®ã§ã€ã“ã“ã‹ã‚‰ã¯å®Ÿéš›ã« Promise ãƒã‚§ãƒ¼ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã«æ³¨åŠ›ã—ã¦å­¦ç¿’ã‚’ã™ã™ã‚ã¦ã„ãã¾ã™ã€‚ã¾ãŸã€Promise ã¾ã‚ã‚Šã®ç´°ã‹ã„ç–‘å•ã‚’èª¿ã¹å°½ãã—ã¦è§£æ¶ˆã—ã¦ã„ãã¾ã™ã€‚

- Microtask ã¨ Macrotask ã®ä¸¡æ–¹ã‚’å¿µé ­ã« Promise ãƒã‚§ãƒ¼ãƒ³ã‚’æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- åŒæœŸå‡¦ç†ã¨éžåŒæœŸå‡¦ç†ã‚’æ··åœ¨ã•ã›ãŸ Promise ãƒã‚§ãƒ¼ãƒ³ã‚’æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- Promise ãƒã‚§ãƒ¼ãƒ³ã§å€¤ã‚’æ¬¡ã®ãƒã‚§ãƒ¼ãƒ³ã¸ã¨æ¸¡ã—ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ­£ã—ãè¡Œãˆã‚‹ã‚ˆã†ãªãƒã‚§ãƒ¼ãƒ³æ§‹ç¯‰ã‚’ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ã“ã“ã§ Async function ã¨ `await` ã®ã“ã¨ã‚‚è€ƒãˆã¦ã—ã¾ã†ã¨ã‹ãªã‚Šæ··ä¹±ã™ã‚‹ã®ã§ Promise ãƒã‚§ãƒ¼ãƒ³ã®ã“ã¨ã«æ³¨åŠ›ã—ãŸæ–¹ãŒã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã“ã®æ®µéšŽã§ã¯ azu æ°ã® "JavaScript Promise ã®æœ¬" ã®ã‚³ãƒ©ãƒ ãªã©ãŒéžå¸¸ã«æœ‰ç”¨ã§ã€å¤§å¤‰ãŠä¸–è©±ã«ãªã‚Šã¾ã—ãŸã€‚

https://azu.github.io/promises-book/#promise-is-always-async

ã¾ãŸã€mdn ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè‰²ã€…ãªç–‘å•ã‚’è§£æ¶ˆã—ã¦ãã‚ŒãŸã®ã§ä¸»ã«æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’å«ã‚€éžåŒæœŸå‡¦ç†ã«é–¢é€£ã™ã‚‹ãƒšãƒ¼ã‚¸ã‚’èª­ã‚“ã§ã„ãã®ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Using_promises

ä¸Šè¨˜ã® mdn ã®è§£èª¬ã§ã‚‚ Promise ã«é–¢ã—ã¦ã®ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ãŒã€ä¸‹è¨˜ã®ãƒšãƒ¼ã‚¸ã«ãŠã„ã¦ã„ãã¤ã‚‚ã® Promise ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ï¼‘ã¤ãšã¤ç†è§£ã—ã¦ã„ãã¾ã™ã€‚

https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html

ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãã®ç†ç”±ã‚’ç†è§£ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ Promise ã®æ›–æ˜§ã ã£ãŸã¨ã“ã‚ãŒéžå¸¸ã«ã‚¯ãƒªã‚¢ã«ãªã£ã¦ã„ãã®ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

ã•ã¦ã€ã“ã“ã¾ã§æ¥ã‚Œã°åŸºç¤Žçš„ãª Promise ãƒã‚§ãƒ¼ãƒ³ãŒã‚ã‚‹ç¨‹åº¦æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã¨æ€ã„ã¾ã™ã€‚è‡ªåˆ†ã‚‚ã“ã®æ™‚ç‚¹ã§éžåŒæœŸ API ãªã©ã®ä½¿ã„æ–¹ã‚‚ã‚ã‚‹ç¨‹åº¦ã‚ã‹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## async/await ã®æœ¬æ ¼çš„ãªå­¦ç¿’

ã“ã“ã‹ã‚‰æœ¬æ ¼çš„ã« async/await ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®å­¦ç¿’ãŒå§‹ã¾ã‚Šã¾ã™ã€‚ç‰¹ã« `await` ãŒã‚„ã£ã‹ã„ã§ã™ã€‚éžåŒæœŸé–¢æ•°ã®å†…éƒ¨ã§ã® await ã«ã‚ˆã£ã¦ã€Œã“ã‚Œã¯åŒæœŸå‡¦ç†ãªã®ã‹ã€éžåŒæœŸå‡¦ç†ãªã®ã‹ã€ãŒã‚ˆãã‚ã‹ã‚‰ãªããªã£ã¦ãã¾ã™ã€‚JavaScript Visualizer 9000 ã§ã¯ async/await ãŒä½¿ãˆãšå¯è¦–åŒ–ã§ããªã„ãŸã‚ã€æ‰‹å…ƒã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦å®Ÿè¡Œã—ã¦ã„ãã“ã¨ã‚’ãƒ¡ã‚¤ãƒ³ã«ã—ã¦ç†è§£ã—ã¦ã„ãã¾ã™ã€‚

è‡ªåˆ†ã®å ´åˆã¯ã€ã„ã¾ã¾ã§ã‚„ã£ã¦ããŸ Promies ã®è€ƒãˆæ–¹ã¨å™›ã¿åˆã‚ãªã‹ã£ãŸã‚Šã€Promise ã¨ã®çµ„ã¿åˆã‚ã›æ–¹ã‚’ç†è§£ã™ã‚‹ã¾ã§ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯ Promise ãŒç†è§£ã—ãã‚Œã¦ã„ãªã‹ã£ãŸã“ã¨ã‚’æ„å‘³ã—ã¦ã„ã¾ã™ã€‚**è¤‡æ•°ã® `await` å‡¦ç†ã®å…¥ã£ãŸè¤‡æ•°ã®éžåŒæœŸé–¢æ•°ã®å‡¦ç†ã‚’ Promise ãƒã‚§ãƒ¼ãƒ³ã§å®Ÿç¾ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™**ã€‚Promise ãƒã‚§ãƒ¼ãƒ³ãªã‚‰ JavaScript Visualizer 9000 ã§å¯è¦–åŒ–ã§ãã¾ã™ã®ã§ã€‚

ã¾ãŸã€æœ€åˆã¯ async/await ã«ã‚ˆã£ã¦ Promise ãŒã„ã‚‰ãªããªã£ã¦ã—ã¾ã†ã®ã‹ã¨ã‚‚æ€ã„ã¾ã—ãŸãŒã€ãã‚“ãªã“ã¨ã¯ç„¡ã‹ã£ãŸã§ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®è¤‡æ•°ã® Promise ã‚’æ‰±ã†ã“ã¨ã®ã§ãã‚‹é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å­¦ç¿’ã™ã‚‹ã“ã¨ã§å˜ç´”ãª async/await ã§ã‚„ã‚‹ã‚ˆã‚Šã‚‚**åŠ¹çŽ‡çš„ã«ç›®çš„ã‚’ã¯ãŸã›ã‚‹**ã“ã¨ã‚’ç†è§£ã§ãã‚Œã°ä½“æ„Ÿã§ãã‚‹ã¯ãšã§ã™ã€‚

- [Promise.all()](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Promise/all)
- [Promise.race()](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Promise/race)
- [Promise.allSettled()](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled) 
- [Promise.any()](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Promise/any)

mdn ã§å„ãƒ¡ã‚½ãƒƒãƒ‰ã®è§£èª¬ã‚„æ¬¡ã®è¨˜äº‹ã‚’èª­ã‚€ã®ã‚’ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ã€‚ãã‚Œãžã‚Œã®ä½¿ã„ç”¨é€”ã‚„é•ã„ãªã©ãŒã‚ãã‚‰ã‹ã«ãªã‚‹ã¨ async/await ã§ã§ãã‚‹ã“ã¨ã€å˜ç´”ãª `await` å¼ã«ã®ã¿æ³¨åŠ›ã—ã¦ã—ã¾ã†ã¨ã‚„ã‚Šã¥ã‚‰ã„ã“ã¨ãŒé€†ã«åˆ†ã‹ã£ã¦ãã‚‹ã¯ãšã§ã™ã€‚

https://okapies.hateblo.jp/entry/2020/12/13/154311

æ›´ã«ã“ã‚Œã«ã‚ˆã£ã¦ async/await ãŒ Promise ã‚’ä»£æ›¿ã™ã‚‹ã®ã§ã¯ãªãã€Promise ãƒ™ãƒ¼ã‚¹ã®éžåŒæœŸå‡¦ç†ã®åˆ©ä¾¿æ€§ã‚’ä¸€éƒ¨å‘ä¸Šã•ã›ã‚‹ Promise ã¨ã„ã†ã‚·ã‚¹ãƒ†ãƒ è‡ªä½“ã«åŸºã¥ã„ãŸæ‹¡å¼µçš„ãªæ©Ÿèƒ½ã§ã‚ã‚Šã€**Promise ã¨ä¸€ç·’ã«ä½¿ã£ã¦ã„ãã‚‚ã®**ã§ã‚ã‚‹ã¨ã„ã†ã“ã¨ãŒèªè­˜ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

ãã‚‚ãã‚‚ã€`await` å¼ã¯ã€Œå³è¾ºã® Promise ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ Settled çŠ¶æ…‹(Fullfilled ã¾ãŸã¯ Rejected çŠ¶æ…‹)ã«ãªã‚‹ã¾ã§éžåŒæœŸå‡¦ç†ã®å®Œäº†ã‚’å¾…ã¡ã€Promise ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ…‹ãŒå¤‰åŒ–ã—ãŸã‚‰ãã® Promise ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®**è©•ä¾¡çµæžœã‚’å€¤ã¨ã—ã¦è¿”ã™**ã€ã‚‚ã®ãªã®ã§ã€Promise ã‚’æ‰±ã£ã¦ã„ã‚‹ã¨èªè­˜ã—ã¦ã—ãªã„ã¨ã‚„ã£ã™ã‚“æ°ã®å‹•ç”»ã§ç´¹ä»‹ã•ã‚ŒãŸãƒŸã‚¹(ãƒžã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã™ã‚‹ `setTimeout` é–¢æ•°ã‚’ Promise ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ã“ã¨ãªããã®ã¾ã¾ `await` ã—ã¦ã—ã¾ã†ãªã©)ã‚’çŠ¯ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

:::message
`await` å¼ã§ã¯éžåŒæœŸé–¢æ•°ã®å†…éƒ¨ã§éžåŒæœŸå‡¦ç†ã®å®Œäº†ã‚’å¾…ã¡ã¾ã™ãŒã€ãã®"å¾…ã£ã¦ã„ã‚‹"ã¨ã„ã†ã®ã¯å®Ÿéš›ã«ã™ã¹ã¦ã®å‡¦ç†ãŒæ­¢ã¾ã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªãã€éžåŒæœŸé–¢æ•°ã®å‘¼ã³å‡ºã—å…ƒã«ä¸€æ—¦åˆ¶å¾¡ãŒæˆ»ã£ã¦åˆ¥ã®å‡¦ç†ã‚’å†é–‹ã—ã€`await` ã§å¾…ã£ã¦ã„ãŸ Promise ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè§£æ±ºã—ãŸå¾Œã«å†ã³éžåŒæœŸé–¢æ•°ã«æˆ»ã£ã¦ `await` å¼ã®å¾Œã«ã‚ã‚‹æ¬¡ã®å‡¦ç†ã‚’å†é–‹ã™ã‚‹ã¨ã„ã†ã“ã¨ã‚’æ„å‘³ã—ã¦ã„ã¾ã™ã€‚

éžåŒæœŸé–¢æ•°ã®ä¸­ã®å‡¦ç†ã¯ 1 ã¤ 1 ã¤å‡¦ç†ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰é †ç•ªã«å‡¦ç†ãŒé€²ã‚€ã®ã§ã€ã€Œé€æ¬¡çš„(é †æ¬¡çš„)ãªå‡¦ç†ã€ãŒãŠã“ãªã‚ã‚Œã¦ã„ã¾ã™ãŒã€`await` å¼ã«å‡ºä¼šã†ãŸã³ã«ã€ä¸€åº¦åˆ¶å¾¡ã‚’å‘¼ã³å‡ºã—å…ƒã«æˆ»ã—ã¦åˆ¥ã®åŒæœŸå‡¦ç†ãªã©ã‚’å®Ÿè¡Œã—ã¤ã¤ã€`await` ã§å¾…ã£ã¦ã„ãŸ Promise ãŒè§£æ±ºã•ã‚ŒãŸã‚‰ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã®çŠ¶æ³ã‚’è¦‹ã¦å†ã³åˆ¶å¾¡ãŒéžåŒæœŸé–¢æ•°ã«æˆ»ã‚‹ã®ã§ã€å®Ÿéš›ã«åˆ¶å¾¡ã®æµã‚Œã¯ã€ŒåŒæœŸçš„ã€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã¯ Promise ãƒã‚§ãƒ¼ãƒ³ã§ã‚‚åŒã˜çŠ¶æ³ã¨ãªã‚Šã¾ã™ã€‚`then()` ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã¯ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ã¸ã¨ä¸€æ—¦é€ã‚‰ã‚Œã€åˆ¶å¾¡ã¯å‘¼ã³å‡ºã—å…ƒã«æˆ»ã‚Šã¾ã™ã€‚ä¹±æš´ãªè¨€ã„æ–¹ã§ã™ãŒã€async/await ã¯æœ¬è³ªçš„ã«ã¯ Promise ãƒã‚§ãƒ¼ãƒ³ã®æ›¸ãæ–¹ã‚’å¤‰ãˆã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

ã‚‚ã—ã€ŒåŒæœŸçš„ã€ã«å‡¦ç†ãŒé€²ã‚“ã§ã„ã‚‹ãªã‚‰ã€éžåŒæœŸé–¢æ•°ã®å†…éƒ¨ã§ `await` å¼ã«ã‚ˆã£ã¦ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå°‚æœ‰ã•ã‚Œã‚‹ã“ã¨ã§ã€Œãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã€ãŒç™ºç”Ÿã—ã€ãã®é–“ã¯ä¸€åˆ‡ã®å‡¦ç†ãŒé€²ã¾ãªã„ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“ã€ãã‚“ãªã“ã¨ã¯èµ·ãã¦ã„ã¾ã›ã‚“ã€‚ãã‚“ãªã“ã¨ãŒèµ·ãã‚‹ãªã‚‰ã€ãã‚‚ãã‚‚ã€ŒéžåŒæœŸå‡¦ç†ã€ã‚’è¡Œã†ãƒ¡ãƒªãƒƒãƒˆãªã‚“ã¦ãªã„ã§ã™ã‚ˆã­ã€‚

Prmoise ãƒã‚§ãƒ¼ãƒ³ã‚„ `await` å¼ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ Async function ã®åˆ¶å¾¡ãŒã€ŒåŒæœŸçš„ã€ã§ã‚ã‚‹ã¨æ··åŒã—ã¦ã—ã¾ã†ã®ã¯ã€ Promise ãƒã‚§ãƒ¼ãƒ³ã‚„éžåŒæœŸé–¢æ•°å†…ã®å‡¦ç†ã®ã¿ã«ã¤ã„ã¦è€ƒãˆã‚Œã°ç¢ºã‹ã«ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«ã€Œé€æ¬¡çš„(é †æ¬¡çš„)ã€ã«å‡¦ç†ãŒé€²ã‚“ã§ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚ã—ã‹ã—ã€**ãã®ã‚¹ãƒ†ãƒƒãƒ—ã®é–“ã§ã¯åˆ¥ã®å‡¦ç†ãŒé€²ã‚“ã§ã„ã¾ã™**ã€‚

ã€ŒåŒæœŸã€ã‚„ã€ŒéžåŒæœŸã€ã¨ã„ã†è¨€è‘‰ã«æŒ¯ã‚Šå›žã•ã‚Œã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ã“ã‚Œã‚’ç†è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ãŸã‚ã«ã‹ãªã‚Šæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã—ãŸã€‚"blocking(ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°)" ã¨ "sequential(é€æ¬¡çš„)" ã¨ã„ã†è¨€è‘‰ã«æ³¨è¦–ã—ã¦ãŠãã¨è‰¯ã„ã¨è¨€ã£ãŸã®ã¯ã“ã®ãŸã‚ã§ã™ã€‚

ã€ŒPromise ã¨ã‹ await ã¨ã‹ã£ã¦ã¯å®Ÿã¯éžåŒæœŸå‡¦ç†ã§ã¯ãªã„ã®ã§ã¯ï¼ŸðŸ˜µâ€ðŸ’«ã€ã¨ã„ã†å†’é ­ã®ç–‘å•ã¯ã“ã‚Œã§è§£æ¶ˆã§ãã‚‹ã¯ãšã§ã™ã€‚

async/await ã§ã¯ç„¡ã„ã§ã™ãŒï¼’ã¤ã® Promise ãƒã‚§ãƒ¼ãƒ³ã‚’åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ã®ã‚’å¯è¦–åŒ–ã—ã¦ã¿ã‚‹ã¨åˆ¶å¾¡ãŒè¡Œã£ãŸã‚Šæ¥ãŸã‚Šã—ã¤ã¤ã‚‚ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«å®Ÿè¡Œã—ã¦ã„ã‚‹æ§˜ãŒç†è§£ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚Visualizer ã§å¯è¦–åŒ–ã—ã¦ã¿ãŸã®ã§ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚
[doublePromiseChain.js - JS Visualizer 9000](https://www.jsv9000.app/?code=Ly8gZG91YmxlUHJvbWlzZUNoYWluLmpzCgovLyB0aGluayBhd2FpdCB3aXRoIHByb21pc2VzCi8vIHJlbW92ZSBuZXN0aW5nLCBhbHdheSBlbmRzIHdpdGggY2F0Y2goKSBtZXRob2QKZnVuY3Rpb24gcmV0dXJuUHJvbWlzZUZuQSgpIHsKICBjb25zb2xlLmxvZygiLS0%2BIEVudGVyIHJldHVyblByb21pc2VGbkEiKTsKICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKDEwMCkKICAgIC50aGVuKGZ1bmN0aW9uIGExKGRhdGEpIHsKICAgICAgY29uc29sZS5sb2coIi0tPiBFbnRlciB0aGVuIGNhbGxiYWNrOiBhMSIsIGRhdGEpOwogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKDEwMSk7CiAgICB9KQogICAgLnRoZW4oZnVuY3Rpb24gYjEoZGF0YSkgewogICAgICBjb25zb2xlLmxvZygiLS0%2BIEVudGVyIHRoZW4gY2FsbGJhY2s6IGIxIiwgZGF0YSk7CiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoMTAyKTsKICAgIH0pCiAgICAudGhlbihmdW5jdGlvbiBjMShkYXRhKSB7CiAgICAgIGNvbnNvbGUubG9nKCItLT4gRW50ZXIgdGhlbiBjYWxsYmFjazogYzEiLCBkYXRhKTsKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgxMDMpOwogICAgfSkKICAgIC50aGVuKGZ1bmN0aW9uIGQxKGRhdGEpIHsKICAgICAgY29uc29sZS5sb2coIi0tPiBFbnRlciB0aGVuIGNhbGxiYWNrOiBkMSIsIGRhdGEpOwogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKDEwNCk7CiAgICB9KQogICAgLmNhdGNoKChlKSA9PiBjb25zb2xlLmVycm9yKGUpKTsKfQoKZnVuY3Rpb24gcmV0dXJuUHJvbWlzZUZuQigpIHsKICBjb25zb2xlLmxvZygiLS0%2BIEVudGVyIHJldHVyblByb21pc2VGbkIiKTsKICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKDIwMCkKICAgIC50aGVuKGZ1bmN0aW9uIGEyKGRhdGEpIHsKICAgICAgY29uc29sZS5sb2coIi0tPiBFbnRlciB0aGVuIGNhbGxiYWNrOiBhMiIsIGRhdGEpOwogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKDIwMSk7CiAgICB9KQogICAgLnRoZW4oZnVuY3Rpb24gYjIoZGF0YSkgewogICAgICBjb25zb2xlLmxvZygiLS0%2BIEVudGVyIHRoZW4gY2FsbGJhY2s6IGIyIiwgZGF0YSk7CiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoMjAyKTsKICAgIH0pCiAgICAudGhlbihmdW5jdGlvbiBjMihkYXRhKSB7CiAgICAgIGNvbnNvbGUubG9nKCItLT4gRW50ZXIgdGhlbiBjYWxsYmFjazogYzIiLCBkYXRhKTsKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgyMDMpOwogICAgfSkKICAgIC50aGVuKGZ1bmN0aW9uIGQyKGRhdGEpIHsKICAgICAgY29uc29sZS5sb2coIi0tPiBFbnRlciB0aGVuIGNhbGxiYWNrOiBkMiIsIGRhdGEpOwogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKDIwNCk7CiAgICB9KQogICAgLmNhdGNoKGUgPT4gY29uc29sZS5lcnJvcihlKSk7Cn0KCnJldHVyblByb21pc2VGbkEoKQogIC50aGVuKChkYXRhKSA9PiB7CiAgICBjb25zb2xlLmxvZygiQWZ0ZXIgZXhlY3V0aW5nIEZuQSIsIGRhdGEpOwogIH0pOwpyZXR1cm5Qcm9taXNlRm5CKCkKICAudGhlbigoZGF0YSkgPT4gewogICAgY29uc29sZS5sb2coIkFmdGVyIGV4ZWN1dGluZyBGbkEiLCBkYXRhKTsKICB9KTsKCgo%3D)
:::

"JavaScript Primer" ã«æˆ»ã£ã¦ãã‚‹ã¨ã€ã€ŒPromise ã¨ async/await ã¯ä¸€ç·’ã«ä½¿ã£ã¦ã„ãã‚‚ã®ã§ã‚ã‚‹ã€ã¨ã„ã†ã“ã¨ã‚’å†ç™ºè¦‹ã§ãã¾ã™ã€‚

https://jsprimer.net/basic/async/#relationship-promise-async-function

>ã“ã®ã‚ˆã†ã«Async Functionã‚„awaitå¼ã¯æ—¢å­˜ã®Promise APIã¨çµ„ã¿åˆã‚ã›ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚ Async Functionã‚‚å†…éƒ¨çš„ã«Promiseã®ä»•çµ„ã¿ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€ä¸¡è€…ã¯å¯¾ç«‹é–¢ä¿‚ã§ã¯ãªãå…±å­˜é–¢ä¿‚ã«ãªã‚Šã¾ã™ã€‚  
>(ä¸Šè¨˜ãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨)

Promise ã®é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã¨ `await` å¼ã‚’çµ„ã¿åˆã‚ã›ã‚‹ä¾‹ã¨ã—ã¦ã€è¤‡æ•°ã®ãƒªã‚½ãƒ¼ã‚¹éžåŒæœŸçš„ã«å–å¾—ã™ã‚‹éš›ã« Async function å†…ã§ `await promise1; await promise2; await promise3;` ã®ã‚ˆã†ã«ï¼‘ã¤ãšã¤å–å¾—ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã¤ã®ã§ã¯ãªãã€`await Promise.allSettled([promise1, promise2, promise3]);` ã¨ã—ã¦è¤‡æ•°ã®éžåŒæœŸå‡¦ç†ã‚’ä¸¦è¡Œã—ã¦èµ°ã‚‰ã›ã‚‹ã“ã¨ã§ãƒªã‚½ãƒ¼ã‚¹ã®å–å¾—æ™‚é–“ã‚’å‰Šæ¸›ã§ãã‚‹ãªã©ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

ã¤ã¾ã‚Šã€"async/await" ã§ã¯ãªãã€"**Promise with async/await**" çš„ãªãƒŽãƒªã§ã‚ã‚‹ã“ã¨ã‚’ç†è§£ã§ãã¾ã™ã€‚

ã¾ãŸã€ãƒ¢ãƒ€ãƒ³ãª JavaScript/TypeScript ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚ã‚‹ Deno ã§ã¯ Node.js ã¨æ¯”è¼ƒã—ãŸã¨ãã®ç‰¹å¾´ã¨ã—ã¦ã€ŒDeno ã§ã®éžåŒæœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã™ã¹ã¦ Promise ã‚’è¿”ã™ã€ã¨ã„ã†ç‚¹ã‚’ã‚ã’ã¦ã„ã¾ã™ã€‚

>All async actions in Deno return a promise. Thus Deno provides different APIs than Node.  
>([Introduction - Deno Manual](https://deno.land/manual#comparison-to-nodejs) ã‚ˆã‚Šå¼•ç”¨)

"Async/await-based" ã‚„ "Async/await-first" ã§ã¯ãªãã€"Promise-based "ã‚„ "Promise-first" ãªã©ã®è¨€è‘‰ã‚’èžã„ãŸã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ãã®ç†ç”±ã¯ "Promise" ãŒå¸¸ã«éžåŒæœŸå‡¦ç†ã®ä¸»å½¹ã ã‹ã‚‰ã§ã™ã€‚

ãã‚ŒãŒç†è§£ã§ããŸã‚‰ã€ä»Šåº¦ã“ã async/await ã®å¼·ã¿ã‚’ç†è§£ã™ã‚‹æ®µéšŽã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

https://developers.google.com/web/fundamentals/primers/async-functions#%E4%BE%8B_%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%81%AE%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0

éžåŒæœŸå‡¦ç†ã®ãƒ«ãƒ¼ãƒ—ãªã©ã‚’æ§‹ç¯‰ã™ã‚‹éš›ã«ã€Promise ãƒã‚§ãƒ¼ãƒ³ã§ã¯è¤‡é›‘ã«ãªã£ã¦ã—ã¾ã†ã‚³ãƒ¼ãƒ‰("ã‚¹ãƒžãƒ¼ãƒˆ"ãªæ›¸ãæ–¹ã®ã‚³ãƒ¼ãƒ‰)ã‚’ã€Async function å†…ã§ã¯ `while` ãƒ«ãƒ¼ãƒ—ã‚„ `for` ãƒ«ãƒ¼ãƒ—ã¨ã„ã£ãŸ"ã‚·ãƒ³ãƒ—ãƒ«ã§èª­ã¿ã‚„ã™ã„å¹³å‡¡ãªæ›¸ãæ–¹"ã¸ã¨æŒã¡è¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

é€†ã«ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã« Async function ã‚’ä½¿ã†æ™‚ã¯æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã‚Šã€ã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã©ã‚Œã‚’ await ã•ã›ã‚‹ã‹ãªã©ã®é›£ã—ã•ã‚‚åˆ†ã‹ã£ã¦ãã¾ã™ãŒã€‚

ãã‚ŒãŒå‡ºæ¥ãŸã‚‰ã€ä»•ä¸Šã’ã« "Top-level await" ã‚’å­¦ã³ã¾ã™ã€‚Top-level await ã§ `fetch` ãªã©ã®éžåŒæœŸ API ãŒç°¡å˜ã«ä½¿ãˆã‚‹ã‹ã‚‰ã¨è¨€ã£ã¦ã€ã„ããªã‚Š Top-level await ã‚’å­¦ã‚“ã§ã—ã¾ã£ãŸå ´åˆã¯ **é€šå¸¸ã® async/await ã«ãŠã‘ã‚‹ã€ŒåŒæœŸã¨éžåŒæœŸã€ãŒåˆ†ã‹ã‚‰ãªããªã£ã¦ã—ã¾ã„**ã€éžå¸¸ã«æ··ä¹±ã™ã‚‹ã“ã¨ãŒäºˆæ¸¬ã•ã‚Œã‚‹ã®ã§ã€ã“ã®æœ€å¾Œã®æ®µéšŽã§å­¦ã¶ã“ã¨ã‚’ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ã€‚

https://qiita.com/uhyo/items/0e2e9eaa30ec2ff05260

ã•ã¦ã€ã“ã“ã¾ã§ãã‚Œã°ã€ã€ŒéžåŒæœŸå‡¦ç†ã®åŸºç¤ŽãŒèº«ã«ã¤ã„ãŸã€ã¨ã„ãˆã‚‹çŠ¶æ…‹ã«ãªã£ãŸã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚ã‚‚ã¡ã‚ã‚“ã€éžåŒæœŸå‡¦ç†ã®ã™ã¹ã¦ã‚’å­¦ã³ãã£ãŸè¨³ã§ã¯ãªã„ã®ã§ã€ä»Šå¾Œã‚‚å­¦ç¿’ã¯ç¶šãã¾ã™(éžåŒæœŸã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ `for await...of` ã‚„ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ãªã©ã¯ã¾ã è‡ªåˆ†ã‚‚ã‚ã‹ã‚Šã¾ã›ã‚“)ã€‚

~~ä»¥ä¸ŠãŒè‡ªåˆ†ãªã‚Šã«ã€Œã‚ã‚‹ç¨‹åº¦ã€éžåŒæœŸå‡¦ç†ãŒç†è§£ã§ããŸè¨€ãˆã‚‹çŠ¶æ…‹ã€ã¾ã§åˆ°é”ã™ã‚‹ã®ã«è¾¿ã£ã¦ããŸãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—ã§ã™ã€‚~~
è¿½è¨˜ã«è‰²ã€…è¨˜è¼‰ã—ã¾ã—ãŸãŒã€ã“ã‚Œã§ã‚‚ã¾ã ç†è§£ã—ãã‚Œã¦ã„ãªã„éƒ¨åˆ†ãŒå¤šãã‚ã£ãŸã®ã§ã€ã¾ã è©±ã¯ç¶šãã¾ã™ã€‚

## API ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ç’°å¢ƒã«ã¤ã„ã¦å­¦ã¶ (è¿½è¨˜)
å®Ÿã¯ã€éžåŒæœŸå‡¦ç†ã®ãŸã‚ã®ã€ŒECMAScriptã€ã®è¨€èªžæ©Ÿèƒ½ã ã‘ã‚’è¦‹ã¦ã„ã¦ã‚‚ã€JavaScript ã«ãŠã‘ã‚‹éžåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿ã¯ç†è§£ã§ãã¾ã›ã‚“ã€‚

:::message
å®Ÿã¯ã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã‹ã‚‰é•å’Œæ„ŸãŒã‚ã‚Šã€å†åº¦èª¿ã¹ç›´ã—ãŸçµæžœã¨ã—ã¦ç†è§£ã§ãã¾ã—ãŸðŸ˜‡
é–“é•ã„ãŒã‚ã‚Œã°æŒ‡æ‘˜ã—ã¦ã„ãŸã ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚
:::

"JavaScript" ã®å¢ƒç•Œç·šãŒã©ã“ã¾ã§ãªã®ã‹ã¯ã¯ã£ãã‚Šã—ã¾ã›ã‚“ãŒã€JavaScript ã¯å¸¸ã«å®Ÿè¡Œã™ã‚‹ç’°å¢ƒãŒã‚ã‚Šã€ãã®**ç’°å¢ƒã«ã‚ˆã£ã¦åˆ©ç”¨ã§ãã‚‹æ©Ÿèƒ½ãŒç•°ãªã‚‹**ã®ã§ã€ECMAScript(JavaScript ã®è¨€èªžã‚³ã‚¢)ã«ãŠã‘ã‚‹éžåŒæœŸå‡¦ç†ã®æ©Ÿèƒ½ã‚’è€ƒãˆã‚‹ã‚ˆã‚Šã‚‚ã€ã€Œç’°å¢ƒã¨çµã³ã¤ã„ãŸã‚‚ã®ã¨ã—ã¦ã® JavaScript ã®éžåŒæœŸå‡¦ç†ã€ã€ã²ã„ã¦ã¯ã€Œç’°å¢ƒãã®ã‚‚ã®ã€ã®ã“ã¨ã‚’è€ƒãˆãªã„ã¨éžåŒæœŸå‡¦ç†ã‚’ç†è§£ã§ãã¾ã›ã‚“ã€‚

ã¨ã„ã†ã®ã‚‚ã€`setTimeout()` ã®ã‚¿ã‚¤ãƒžãƒ¼å‡¦ç†ã‚„ `fetch()` ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŽ¥ç¶šã‚’ã—ã¦ãƒ‡ãƒ¼ã‚¿å–å¾—ã™ã‚‹ã¨ã„ã†ã€Œæ ¹æœ¬çš„ãªå‡¦ç†ã€ã‚’å®Ÿéš›ã«ã€Œãƒžãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã®ä¸¦åˆ—(parallel)å‡¦ç†ã§ã€è¡Œã£ã¦ãã‚Œã¦ã„ã‚‹ã®ã¯æ¬¡ã®ã‚‚ã®ã ã‹ã‚‰ã§ã™ã€‚

- Web APIs ã‚’æä¾›ã™ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒ (Chrome ã®å ´åˆ)
- Runtime APIs ã‚’æä¾›ã™ã‚‹ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒ (Node.js ã‚„ Deno ã®å ´åˆ)

https://www.freecodecamp.org/news/async-await-javascript-tutorial/

>It turns out that it is **the environment** that takes on the work, and the way to get the environment to do that work, is to use functionality that belongs to the environment. For example fetch or setTimeout in the browser environment.
>(ä¸Šè¨˜ãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨)

å¾“ã£ã¦ã€ECMAScript ã®è¨€èªžã¨ã—ã¦ã®ã€ŒPromise ã‚„ async/await ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚„ã€Œã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ã¨ä¸¦è¡Œ(concurrent)å‡¦ç†ã€ã‚’è€ƒãˆã¦ã„ã¦ã‚‚ç¾å®Ÿã«èµ·ã“ã‚‹ã€ŒéžåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿ã€ã«ã¤ã„ã¦ã®è¬ŽãŒæ°¸é ã«è§£ã‘ã¾ã›ã‚“ã€‚

ä¾‹ãˆã°ã€`fetch()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ ECMAScript ã®ä¸€éƒ¨ã§ã¯ãªãã€Web APIs(Web Platform APIs) ã®ä¸€éƒ¨ã§ã‚ã‚‹ Fetch API ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ã‚Šã€å®Ÿéš›ã«ãã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã®ã¯ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã‚„ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒã§ã™ã€‚

Chrome ã¨ã„ã£ãŸãƒ¢ãƒ€ãƒ³ãªãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã‚’ä»£è¡¨ã¨ã—ã¦è€ƒãˆã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãã‚‚ãã‚‚æ§˜ã€…ãªã‚¿ã‚¹ã‚¯ã‚’è¡Œã£ã¦ã„ã‚‹ã®ã§ã€"ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰"ãªã©ã§ã¯ãªãã€ãƒžãƒ«ãƒãƒ—ãƒ­ã‚»ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã‚ã‚Šã€æ§˜ã€…ãªã‚¿ã‚¹ã‚¯ã®è²¬å‹™ã‚’æŒã¤åˆ†é›¢ã—ãŸãƒ—ãƒ­ã‚»ã‚¹ã®ä¸­ã«è¤‡æ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æŒã¤å½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚

https://developer.chrome.com/blog/inside-browser-part2/

Chrome ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªè¤‡æ•°ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
- Browser process
- Renderer process
- GPU process
- Plugin process
- Extensions process
- Utility process

`setTimeout(cb, delay)` ã®ä¾‹ã§ã¯ã€æŒ‡å®šã—ãŸæ™‚é–“å¾Œã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ Macrotask queue ã¸ã¨è¿½åŠ ã—ã€Event Loop ã«ã‚ˆã£ã¦ Call stack ã¸ã¨é‹ã‚“ã§ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’ã€Œã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ã€ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã¨è§£é‡ˆã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ãŒã€ã€Œç¾å®Ÿã®ã‚¿ã‚¤ãƒžãƒ¼å‡¦ç†ã€ã¯ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã§ã™ã€‚ã‚‚ã—ã‚¿ã‚¤ãƒžãƒ¼å‡¦ç†ãŒãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ãªã‚‰ãã‚Œã“ã**ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹ã¯ãš**ã§ã™ã‹ã‚‰ã€‚
`setTimeout()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã‚„ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒãŒæä¾›ã™ã‚‹ API ã§ã‚ã‚Šã€ãã®ã€Œã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã™ã‚‹ã¾ã§ã®æ™‚é–“ã‚’å›³ã‚‹ã€ã¨ã„ã†å‡¦ç†è‡ªä½“ã¯ç’°å¢ƒã®åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è‡ªä½“ã¯ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‡¦ç†ã•ã‚Œã‚‹ãŒã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã™ã‚‹ãŸã‚ã®ã‚¿ã‚¤ãƒžãƒ¼å‡¦ç†ã¯åˆ¥ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã‚ã‚Œã¦ãŠã‚Šã€ã€ŒéžåŒæœŸå‡¦ç†=éžåŒæœŸçš„ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†=ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ã¨è€ƒãˆã‚‹ãªã‚‰ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å‡¦ç†ã¨ã„ã†éžåŒæœŸå‡¦ç†ãã®ã‚‚ã®ã¯ä¸¦è¡Œ(concurrent)ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ãŒã€éžåŒæœŸå‡¦ç†ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å›³ã£ã¦ã„ã‚‹ã‚¿ã‚¤ãƒžãƒ¼ã®å‡¦ç†ã¯ç’°å¢ƒã®åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚ã‚Šã€ä¸¦åˆ—(parallel)ã«å®Ÿè¡Œã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€`fetch(url)` ã‚‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æŽ¥ç¶šã‚’ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã‚‹ã®ã«**ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã—ãªã„ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§è¡Œã†ã“ã¨ãŒã§ãã‚‹**ã®ã¯ã€ã€Œç¾å®Ÿã®ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†ã€ãŒãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã‚ã‚Œã¦ã„ãªã„ã‹ã‚‰ã§ã™ã€‚`fetch(url)` ãã®ã‚‚ã®ã®å‡¦ç†ãŒç’°å¢ƒã®åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§ä¸¦åˆ—(parallel)ã«è¡Œã‚ã‚Œã¦ã‚‹ä¸€æ–¹ã§ã€`fetch(url).then(cb)` ã® `cb` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ã¤ã„ã¦ã€ŒéžåŒæœŸå‡¦ç†=éžåŒæœŸçš„ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†=ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ã¨ã—ã¦è€ƒãˆã‚‹ãªã‚‰ã€ãŸã—ã‹ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å‡¦ç†ã¨ã„ã†éžåŒæœŸå‡¦ç†ãã®ã‚‚ã®ã¯ä¸¦è¡Œ(concurrent)ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚

å®Ÿéš›ã€JavaScript ã®éžåŒæœŸå‡¦ç†ã§ã‚ˆãèªžã‚‰ã‚Œã‚‹ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ç¾å®Ÿã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒ(Chrome)ã§ã¯ã€ŒRenderer Process ã® Main threadã€ã®ã“ã¨ã§ã‚ã‚Šã€`fetch()` ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŽ¥ç¶šã‚„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãªã©ã®å‡¦ç†ã‚’è¡Œã£ã¦ã„ã‚‹ã®ã¯ã€ŒBrowser process ã® Network threadã€ã§ã™ã€‚

`await` å¼ã®å‰å¾Œã‚„ Promise ãƒã‚§ãƒ¼ãƒ³ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è‡ªä½“ã¯ç¢ºã‹ã«ã€ŒéžåŒæœŸå‡¦ç†=éžåŒæœŸçš„ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã€ã§ã‚ã‚Šã€ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ã§ä¸¦è¡Œ(concurrent)ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ãŒã€ãã‚Œã‚’ Micortask queue ã‚„ Macrotask queue ã¸ã¨è¿½åŠ ã™ã‚‹ãŸã‚ã®å‡¦ç†è‡ªä½“ã¯ä¸¦åˆ—(parallel)ã§ãƒžãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã§èµ·ãã¦ã„ã¾ã™ã€‚

ã€Œä¸¦åˆ—(parallel)å‡¦ç†ã¨ä¸¦è¡Œ(concurrent)å‡¦ç†ãŒåŒæ™‚ã«èµ·ãã¦ã„ã‚‹ã€ã€ã€Œã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚ã‚Šã€ãƒžãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚ã‚‹ã€ã¨ã„ã†æ–‡å­—ã«ã™ã‚‹ã¨é ­ãŒæ··ä¹±ã™ã‚‹ã‚ˆã†ãªè©±ã§ã™ãŒã€**å¯¾ç«‹ã™ã‚‹æ¦‚å¿µãŒåŒå±…ã—ã¦ã€ŒéžåŒæœŸå‡¦ç†ã€ã®ä»•çµ„ã¿ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹**ã¨è€ƒãˆãªã„ã¨ã¤ã˜ã¤ã¾ãŒåˆã‚ãªã„ã®ã§ã€ã“ã†ãªã‚Šã¾ã™ã€‚

ã“ã®çµè«–ã«è‡³ã£ãŸçµŒç·¯ã¨ã—ã¦ã€æ¬¡ã®æ–‡çŒ®ãŒãƒ¡ã‚¤ãƒ³ã¨ã—ã¦å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚

https://www.telerik.com/blogs/angular-basics-introduction-processes-threads-web-ui-developers

ãã—ã¦ Event Loop ã¨ Call Stack ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®å‹•ç”»ã¨ã—ã¦ç´¹ä»‹ã—ãŸã€ŽWhat the heck is the event loop anyway?ã€ã§ã¯ã€Œ**ä¸€åº¦ã«è¤‡æ•°ã®ã“ã¨ãŒã§ãã‚‹ã®ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä»¥ä¸Šã®ã‚‚ã®ã§ã‚ã‚‹ã‹ã‚‰ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰æä¾›ã•ã‚Œã‚‹ Web APIs ã¯å®Ÿè³ªçš„ã«ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚ã‚‹**ã€ã¨ã„ã†ã“ã¨ãŒå®Ÿã¯èªžã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚ã“ã®å‹•ç”»ã§ã¯ã€Œãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã€ã®ã“ã¨ã«ã¤ã„ã¦ã‚‚èªžã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã€Promise ãƒã‚§ãƒ¼ãƒ³ãªã©ãŒç†è§£ã§ããŸå¾Œã‚‚ä½•åº¦è¦‹è¿”ã—ã¦ã‚‚ã‚ˆã„ã¨æ€ã„ã¾ã™ã€‚

>Right, so I've been kind of partially lying do you and telling you that JavaScript can only do one thing at one time. That's true the JavaScript Runtime can only do one thing at one time. It can't make an AJAX request while you're doing other code. It can't do a setTimeout while you're doing another code. **The reason we can do things concurrently is that the browser is more than just the Runtime**. So, remember this diagram, **the JavaScript Runtime can do one thing at a time, but the browser gives us these other things, gives us these we shall APIs, these are effectively threads**, you can just make calls to, and those pieces of the browser are aware of this concurrency kicks in.
>(ä»¥ä¸‹ã®æ›¸ãèµ·ã“ã—ãƒšãƒ¼ã‚¸ã‹ã‚‰å¼•ç”¨)

https://2014.jsconf.eu/speakers/philip-roberts-what-the-heck-is-the-event-loop-anyway.html

:::message
è£œè¶³: Philip Roberts æ°ãŒè¨€ã† "Runtime" ã¨ã¯ Chrome ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã® JS ã‚¨ãƒ³ã‚¸ãƒ³ã§ã‚ã‚‹ V8 ã®ã“ã¨ã‚’è¨€ã£ã¦ã„ã¾ã™ã€‚Deno ã‚„ Node ã¯ V8 ã‚’å«ã‚“ã "ç’°å¢ƒ"ã§ã‚ã‚Šã€è‰²ã€…ãª API ã‚’æä¾›ã™ã‚‹ã®ã§ã€ã“ã“ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã¨ç­‰ä¾¡ãªã‚‚ã®ã¨ã—ã¦è€ƒãˆã¦ãã ã•ã„ã€‚

ãã‚Œãžã‚Œå…¬å¼ã‚µã‚¤ãƒˆã§ã®æ–‡è¨€ã€‚
- [Deno is a simple, modern and secure runtime for JavaScript and TypeScript that uses V8 and is built in Rust.](https://deno.land)
- [Node.jsÂ® is a JavaScript runtime built on Chrome's V8 JavaScript engine.](https://nodejs.org/en/)

ã¾ãŸã€å¼•ç”¨ã® "we shall APIs" ã¯ãŠãã‚‰ãæ›¸ãèµ·ã“ã—ã®é–“é•ã„ã§ã€å®Ÿéš›ã®å‹•ç”»ã§ã¯ "Web APIs" ã¨è¨€ã£ã¦ã„ã¾ã™ã€‚
:::

â†“ æ›¸ãèµ·ã“ã—ãŒå®Ÿéš›ã®è¨€è‘‰ã¨è‹¥å¹²é•ã£ã¦ã„ã‚‹ã®ã§å‹•ç”»ã§ç¢ºèªã™ã‚‹ã¨ 11:48 ~ ã®ã¨ã“ã‚ã§ã™ã€‚
[ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¨ã¯ä¸€ä½“ä½•ã§ã™ã‹ï¼Ÿ | Philip Roberts | JSConf EU](https://youtu.be/8aGhZQkoFbQ?t=708)

ã‚‚ã†ä¸€åº¦æµã‚Œã‚’ã¾ã¨ã‚ã¾ã™ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã«ãŠã„ã¦ `setTimeout()` ã¨ `fetch()` ã¯ **Web API** ã§ã™(ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒã§ã¯ Runtime API)ã€‚ECMAScript è¨€èªžã®ä¸€éƒ¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸¡æ–¹ã¨ã‚‚è‡ªåˆ†ã§å®šç¾©ã—ãŸé–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã§ã¯ãªã API ã®å‘¼ã³å‡ºã—(API call)ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚API ã‚’ä»‹ã—ã¦ã€Œæ™‚é–“ã‚’å›³ã‚‹ã€ã€ã€Œãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹ã€ã¨ã„ã£ãŸã‚¿ã‚¹ã‚¯ãŒã€Œç’°å¢ƒã€ã¸å§”ä»»(Delegate)ã•ã‚Œã€ãã®ã‚¿ã‚¹ã‚¯ã‚’ã€Œç’°å¢ƒãã®ã‚‚ã®ã€ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä¸¦åˆ—(parallel)ã«è¡Œã„ã¾ã™ã€‚ã€Œç’°å¢ƒã«å§”ä»»ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ãŸã‚‰ä½•ã‹ã‚’ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã†ã€ã¨ã„ã†**ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å½¢**ã§ç™»éŒ²ã—ã¦ãŠã„ãŸåˆ¥ã®ã‚¿ã‚¹ã‚¯(=éžåŒæœŸå‡¦ç†)ã¯ã€å§”ä»»ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’çµ‚ã‚ã‚‰ã›ãŸæ™‚ç‚¹ã§ç’°å¢ƒã‹ã‚‰ Macrotask queue ã‚„ Microtask queue ã¸ã¨é€ã‚‰ã‚Œã€Event Loop ã«ã‚ˆã£ã¦ Call stack ã¸ã¨é‹ã°ã‚ŒãŸæ™‚ç‚¹ã§ JavaScript ã®ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã‚ŒãŒ JavaScript ã«ãŠã‘ã‚‹éžåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿ã§ã™ã€‚

çµå±€ã®æ‰€ã€éžåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ã«ã¯ã€ŒPromise ã‚„ async/await ã¨ã„ã£ãŸè¨€èªžæ©Ÿèƒ½ã®æ¦‚å¿µã¨ãã®ä½¿ã„æ–¹ã€ã ã‘ã§ãªãã€Œ**API ã‚’æä¾›ã™ã‚‹ç’°å¢ƒ**ã€ã®ã“ã¨ã‚’çŸ¥ã‚‹ã“ã¨ãŒå¿…è¦ã ã£ãŸã€ã¨ã„ã†è¨³ã§ã™ã€‚

æœ¬æ¥æ™‚é–“ã®ã‹ã‹ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’ä»‹ã—ãŸãƒ‡ãƒ¼ã‚¿å–å¾—(`fetch()`)ã‚„ I/O (`Deno.readFile()` ã‚„ `fsPromise.readFile()`)ãªã©ã®å‡¦ç†ã¯åŸºæœ¬çš„ã«ç’°å¢ƒãŒ API ã¨ã—ã¦ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“ã™ã¹ã¦ã® API ãŒæ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†ã§ã¯ãªãã€ä¾‹ãˆã°ã€`URL()` ãªã©ã‚‚ Web API ãªã®ã§ç’°å¢ƒã®æä¾›ã™ã‚‹æ©Ÿèƒ½ã§ã™ãŒã€é€šä¿¡ã‚„ I/O ã«æ¯”ã¹ã¦ã™ãã«å‡¦ç†ãŒçµ‚äº†ã™ã‚‹ã®ã§ã€éžåŒæœŸã§ã¯ãªãåŒæœŸçš„ãªã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚

:::message
"blocking" ã®ç”¨èªžã®ã¨ã“ã‚ã§ç´¹ä»‹ã—ã¾ã—ãŸãŒã€Node ã‚„ Deno ã®ç’°å¢ƒã§ã¯æ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†ã®å®Œäº†ã‚’å¾…ã£ã¦ã€ã‚ãˆã¦ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã® Event Loop ã‚’ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã™ã‚‹åŒæœŸ API (Synchronous APIs) ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚Node ãªã‚‰ `fs.readFileSync()`ã€Deno ãªã‚‰ `Deno.readFileSync()` ãªã©ãŒè©²å½“ã—ã¾ã™ã€‚ç”¨é€”ã¨ã—ã¦ã¯ã€ã€Œã‚¹ãƒ‹ãƒšãƒƒãƒˆç¨‹åº¦ã®ã‚³ãƒ¼ãƒ‰ã ã‹ã‚‰ã‚ã–ã‚ã–éžåŒæœŸå‡¦ç†ã«ã™ã‚‹ã¾ã§ã‚‚ãªã„ã€ã¨ã„ã†ã¨ãã‚„ã€ä»–ã®ä½•ã‚‰ã‹ã®ç†ç”±ã§ã‚ãˆã¦éžåŒæœŸå‡¦ç†ã«ã—ãŸããªã„çŠ¶æ³ãªã©ã§ä½¿ç”¨ã—ãŸã‚Šã—ã¾ã™ã€‚

>The synchronous APIs perform all operations synchronously, **blocking the event loop until the operation completes or fails**.
> ([File system | Node.js v17.9.0 Documentation](https://nodejs.org/api/fs.html#synchronous-api) ã‚ˆã‚Šå¼•ç”¨)
:::

API ã‚’ä»‹ã—ã¦æ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†ã¯ç’°å¢ƒã¸å§”ä»»ã•ã‚Œã¾ã™ãŒã€ã‚‚ã—ç’°å¢ƒãŒ API ã¨ã—ã¦ç”¨æ„ã—ã¦ã„ãªã„ã‚ˆã†ãªæ™‚é–“ãŒã‹ã‹ã‚‹ã‚¿ã‚¹ã‚¯(ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é•·æ™‚é–“å°‚æœ‰ã—ã¦ã—ã¾ã†ã‚ˆã†ãªå‡¦ç†)ã‚’**è‡ªåˆ†ã§å®šç¾©ã—ãŸåŒæœŸé–¢æ•°**ãªã©ã§è¡Œã†å ´åˆã¯ã€Web Workers ã§ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰åˆ†é›¢ã—ãŸåˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¦ã€ãã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§ä¸¦åˆ—(parallel)ã«å‡¦ç†ã‚’èµ°ã‚‰ã›ã‚‹ã“ã¨ã§**ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã® Event Loop ã‚’ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã›ãšã«æ¸ˆã¾ã›ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ã„ã‚ã‚†ã‚‹ã€Œã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã€ã¨ã„ã†ã‚„ã¤ã§ã™ã€‚ã‚‚ã¡ã‚ã‚“ Web Workers ã‚‚ Web API ã§ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/API/Web_Workers_API/Using_web_workers

## éžåŒæœŸå‡¦ç†æ©Ÿèƒ½ã‚’ä¿¯çž°ã™ã‚‹ (è¿½è¨˜)
ECMAScript ã«å–ã‚Šå…¥ã‚Œã‚‰ã‚ŒãŸéžåŒæœŸå‡¦ç†ã«é–¢ã™ã‚‹ã‚‚ã®ã¨ã—ã¦ async/await ã®å‰ã« **Generator** ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã—ãŸã€‚ç¾æ™‚ç‚¹ã§ã€ŒéžåŒæœŸå‡¦ç†ã€ã®èª¬æ˜Žã« Generator ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã“ã¨ã¯ã»ã¨ã‚“ã©è¦‹ã‹ã‘ã¾ã›ã‚“ãŒã€async/await ã®æ©Ÿèƒ½ã®å‰ã«ã“ã‚ŒãŒå°Žå…¥ã•ã‚Œã¦ã„ãŸã¨ã„ã†ã“ã¨ã‚’èªè­˜ã—ã¦ãŠãã¨ã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã“ã“ã¾ã§æ¥ã¦ã€è‰²ã€…ãªéžåŒæœŸå‡¦ç†ã®çŸ¥è­˜ã‚’å¾—ãŸã¨æ€ã„ã¾ã™ãŒã€ECMAScript ã®ã€ŒéžåŒæœŸå‡¦ç†ã€ã®ä¿¯çž°ã‚’è¡Œã†ãŸã‚ã« Electron ã®ã‚³ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã‚ã‚‹ Shelley Vohr æ°ãŒ JSConf EU ã§è¡Œã£ãŸè¬›æ¼”å‹•ç”»ã§ã‚ã‚‹ã€ŽAsynchrony: Under the Hoodã€ã‚’è¦‹ã¦ãŠãã¨ã„ã„ã¨æ€ã„ã¾ã™ã€‚

@[youtube](SrNQS8J67zc)

Philip Roberts æ°ã®å‹•ç”»ã‚ˆã‚Šã‚‚æ–°ã—ã„ã®ã§ã€ECMAScript ã®æ©Ÿèƒ½ã¨ã—ã¦æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸ Promise ã®ãŸã‚ã®ã‚­ãƒ¥ãƒ¼ã§ã‚ã‚‹ Microtask queue ãŒå…¥ã£ãŸçŠ¶æ…‹ã® Event loop ã®è©±ã‚’ã—ã¦ã„ã¾ã™ã€‚ã§ã™ãŒã€æœ€åˆã«ã“ã‚Œã‚’è¦‹ã¦ã‚‚å¤šåˆ†ç†è§£ã§ããªã„ã¨æ€ã†ã®ã§ã€ã‚„ã¯ã‚Šã€ŒWhat the heck is the event loop anyway?ã€ã‹ã‚‰è¦–è´ã™ã‚‹ã®ã‚’ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®é …ç›®ã«è§¦ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã€ŒéžåŒæœŸå‡¦ç†ã€ã®å…¨ä½“ã‚’ä¿¯çž°ã§ãã¾ã™ã€‚

- Callback hell
- Promise chain
- Generator
- async/await

æœ€å¾Œã«ã¯ã€Callback hell â†’ Promise chain â†’ async/await ã®å¤‰å½¢ãŒã¿ã‚Œã‚‹ã®ã§ async/await ã¨ Promise ãƒã‚§ãƒ¼ãƒ³ã®æ›¸ãæ›ãˆãŒåˆ†ã‹ã‚‰ãªã„äººã¯è¦‹ã‚‹ã¨ã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã¨ã¯è¨€ã£ã¦ã‚‚éžåŒæœŸå‡¦ç†æ©Ÿèƒ½ã®æ­´å²çš„ãªç™ºå±•ã«ã¤ã„ã¦ã¯ azu æ°ã® JavaScript Primer ã§ã‚‚ã‹ãªã‚Šåˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã¡ã‚‰ã‚’ç†è§£ã—ãŸä¸Šã§è¦–è´ã™ã‚‹ã®ã‚’ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ã€‚

https://jsprimer.net/basic/async/#sync-processing

## Event loop ã¸ã®è§£åƒåº¦ã‚’ä¸Šã’ã‚‹ (è¿½è¨˜)
Event loop ã¨ Call stack ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®å‹•ç”»ã¨ã—ã¦ã¯ã˜ã‚ã®æ–¹ã«ç´¹ä»‹ã—ãŸã€ŽWhat the heck is the event loop anyway?ã€ã¨éžåŒæœŸå‡¦ç†ã®å…¨ä½“ã‚’ä¿¯çž°ã™ã‚‹ãŸã‚ã®å‹•ç”»ã¨ã—ã¦ç´¹ä»‹ã—ãŸã€ŽAsynchrony: Under the Hoodã€ã€Event loop ãŒã©ã®ã‚ˆã†ã«å‹•ãã‹å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ã€ŽJavaScript Visualizer 9000ã€ã¨è‰²ã€…ãªãƒªã‚½ãƒ¼ã‚¹ã‚’ç´¹ä»‹ã—ã¦ãã¾ã—ãŸã€‚ã—ã‹ã—ã€å­¦ç¿’ã‚’é€²ã‚ã¦ã„ãå†…ã«åˆ†ã‹ã£ãŸã“ã¨ã¨ã—ã¦ã€ã“ã‚Œã‚‰ã ã‘ã§ã¯ Event loop ã¸ã®è§£åƒåº¦ãŒè¶³ã‚‰ãšéžåŒæœŸå‡¦ç†ã®åˆ¶å¾¡ã‚’äºˆæ¸¬ã—ãã‚Œãªã„éƒ¨åˆ†ãŒ**å¤šãã‚ã‚Šã¾ã—ãŸ**ã€‚

ãã‚‚ãã‚‚ã€ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã¨ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒã§ã® Event loop ã®å®Ÿè£…ã¯é•ã†ã®ã§ã€å®Ÿéš›ã«ã¯ãã®è¾ºã‚’ç´°ã‹ãç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã‚ã‘ã§ã™ãŒã€ãã®è¾ºã‚Šã®è©±ã‚’è£œã†ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹ã‚‚ç´¹ä»‹ã—ã¦ãŠãã¾ã™ã€‚

:::message
ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®è©±ã¯éžå¸¸ã«ç…©é›‘ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã€ Node ç’°å¢ƒã§ã¯ãƒ•ã‚§ãƒ¼ã‚ºã¨è¿½åŠ ã®ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ã¨ã‚¿ã‚¤ãƒžãƒ¼ãªã©ã€ãã‚Œãžã‚Œè€ƒãˆã‚‹ã¹ãè©±ãŒã‚ã‚‹ãŸã‚ã‹ãªã‚Šè¤‡é›‘ã«ãªã‚Šã¾ã™ã€‚ãã®ãŸã‚ã“ã®æ®µéšŽã§ã¯æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ãªã©ã‚’ä½¿ã£ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’ç†è§£ã—ã¦ã„ãã®ãŒã‚ˆã„ã§ã™ã€‚

ã¾ãŸã€ç†è§£ã‚’è©°ã‚ã‚‹ãŸã‚ã«ä»Šã¾ã§ã®å­¦ç¿’ã‚ˆã‚Šã‚‚**å¤šãã®æ–­ç‰‡çš„ãªãƒªã‚½ãƒ¼ã‚¹ãŒå¿…è¦ã¨ãªã‚Šã¾ã—ãŸ**ã€‚

åŸºæœ¬çš„ã«ã¯ JSConf ã®ã„ãã¤ã‹ã®å‹•ç”»ãŒéžå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®å‹•ç”»ã¯æœ€åˆè¦–è´ã—ãŸéš›ã«ã¯å˜ç´”ã«åˆ†ã‹ã‚Šã«ããã€ã€ŽWhat the heck is the event loop anyway?ã€ãŒæœ€ã‚‚ç†è§£ã—ã‚„ã™ã„ã¨æ„Ÿã˜ã¦ã„ã¾ã—ãŸãŒã€å˜ã«ç†è§£åº¦ãŒè¶³ã‚Šã¦ã„ãªã‹ã£ãŸã ã‘ã ã¨åˆ†ã‹ã‚Šã¾ã—ãŸã€‚

é›£æ˜“åº¦çš„ã«ã¯ JSConf.Asia 2018 ã§ã® Jake Archibald æ°ã®è¬›æ¼”å‹•ç”»ã§ã‚ã‚‹ã€ŽIn The Loopã€ãŒçµæ§‹é›£ã—ã„ã¨æ€ã„ã¾ã™ã€‚
:::

ã¾ãšã€JSConf EU 2018 ã§ã® Erin Zimmer æ°ãŒè¡Œã£ãŸè¬›æ¼”å‹•ç”»ã§ã‚ã‚‹ã€ŽFurther Adventures of the Event Loopã€ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã® Event loop ã‚’æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦è§£èª¬ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚

@[youtube](u1kqx6AenYw)

ã“ã®å‹•ç”»ã§ã¯ Event loop ã¸ã®è§£åƒåº¦ã‚’é£›èºçš„ã«ä¸Šã’ã¦ãã‚Œã¾ã™ã€‚ã“ã®å‹•ç”»ã®ãŠã‹ã’ã§ Event loop ã«ã¤ã„ã¦ä»Šã¾ã§ç†è§£ã—ãã‚Œãªã‹ã£ãŸç‚¹ã«ã¤ã„ã¦ç†è§£ã§ãã¾ã—ãŸã€‚

- Task queue ãŒè¤‡æ•°å­˜åœ¨ã—ã€ã©ã®ã‚­ãƒ¥ãƒ¼ã‚’é¸ã¶ã‹ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒè¡Œã†ã“ã¨
- Event loop å†…ã«ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ«ãƒ¼ãƒ—(ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’å®Œå…¨ã«å‡¦ç†ã™ã‚‹ãƒ«ãƒ¼ãƒ—)ãŒã‚ã‚‹ã“ã¨
- æœ€åˆã® Task ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è©•ä¾¡(Script Evaluation)ã«ãªã‚‹ã“ã¨

æ¬¡ã®ã‚ˆã†ãªæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã§ç†è§£ã§ãã¾ã—ãŸ(å®Ÿéš›ã«ã¯ Chrome ãƒ–ãƒ©ã‚¦ã‚¶ã¯ C++ ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç†è«–çš„ãªç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã¨ãªã‚Šã¾ã™)ã€‚JS Visualizer ã‚’ä½¿ã£ã¦ã„ã‚‹ã ã‘ã§ã¯ç†è§£ã—ã¥ã‚‰ã‹ã£ãŸéƒ¨åˆ†ãŒéžå¸¸ã«ã‚¯ãƒªã‚¢ã«ãªã‚Šã¾ã—ãŸã€‚

```js:æœ€ã‚‚å˜ç´”ãªã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—
// event loop v1
while (true) {
  task = taskQueue.pop();
  execute(task);
}
```

ä¸Šã®å˜ç´”ãªãƒ«ãƒ¼ãƒ—ã‹ã‚‰å§‹ã¾ã‚Šã€æœ€çµ‚çš„ã«ã¯ä»¥ä¸‹ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¾ã§è€ƒãˆãŸãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ãŒç†è§£ã§ãã¾ã™ã€‚

```js:ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—
// event loop v5
// ç„¡é™ãƒ«ãƒ¼ãƒ—
while (true) {
  // è¤‡æ•°ã‚ã‚‹ Task queue ã‹ã‚‰ï¼‘ã¤ã‚’é¸æŠž
  queue = getNextQueue();
  task = queue.pop();
  execute(task);
  // Task ã¯ï¼‘ã¤ã®ã¿å®Ÿè¡Œã™ã‚‹
  
  // Microtask queue ãŒå®Œå…¨ã«ç©ºã«ãªã‚‹ã¾ã§å‡¦ç†ã™ã‚‹
  while (micortaskQueue.hasTasks()) {
    doMicrotask();
  }

  // å‰ã®æç”»æ›´æ–°ã‹ã‚‰ 16 ãƒŸãƒªç§’ã»ã©çµŒã£ã¦ã„ã‚Œã°å†æç”»(60fps)
  if(isReapintTime()) {
    animationTasks = animationQueue.copyTasks();
    // ç¾æ™‚ç‚¹ã«ãŠã„ã¦ã‚­ãƒ¥ãƒ¼ã«ã‚ã‚‹ã‚‚ã®ã™ã¹ã¦ã‚’å®Ÿè¡Œã™ã‚‹
    // Rendering pipeline ç›´å‰ã«ç¢ºå®Ÿã«å‡¦ç†ã™ã‚‹
    for(task in animationTasks) {
      doAnimationTask(task);
    }
    // å†æç”»
    repaint();
  }
}
```

Rendering pipeline ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
https://developer.chrome.com/blog/renderingng-architecture/

ãŸã ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯å®Ÿã¯æƒ…å ±ãŒä¸è¶³ã—ã¦ãŠã‚Šã€Web API `requestAnimationFrame(cb)` (é€šç§° "rAF")ã‹ã‚‰ç™ºè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ä¸­ã§ `queueMicrotask()` ã‚„ `promise.then()` ãªã©ã§ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã¦ã—ã¾ã£ãŸå ´åˆã«ã¯ï¼‘ã¤ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¹ã‚¯ã®å¾Œã«ãã‚Œã‚‰ã‚‚å®Œå…¨ã«å‡¦ç†ã•ã‚Œã‚‹ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€rAF ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ãªæ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’è€ƒãˆã¾ã™ã€‚

```js
requestAnimationFrame(() => {
  console.log('rAF 1');
  Promise.resolve().then(() => {
    console.log('promise in rAF 1');
  });
});
requestAnimationFrame(() => {
  console.log('rAF 2');
  Promise.resolve().then(() => {
    console.log('promise in rAF 2');
  });
});
```

ã“ã‚Œã‚’ Chrome ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ï¼‘ã¤ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¹ã‚¯ãŒå®Ÿè¡Œã•ã‚ŒãŸã‚‰ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒå‡¦ç†ã•ã‚Œã‚‹ã‚ˆã†ãªå‡ºåŠ›ã‚’å¾—ã¾ã™ã€‚

```sh
rAF 1
promise in rAF 1
rAF 2
promise in rAF 2
```

rAF ã‹ã‚‰ç™ºè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒã‚¿ã‚¹ã‚¯ã§ã‚ã‚‹ã¨ã„ã†ã“ã¨ã¯ã€whatwg ã®ä»•æ§˜ã§åè¨€ã•ã‚Œã¦ãŠã‚‰ãšã€Wï¼“C ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã®å¤ã„ä»•æ§˜ã§ç¤ºå”†ã•ã‚Œã¦ã„ã‚‹ã¨ã„ã†ã‚ˆãåˆ†ã‹ã‚‰ãªã„çŠ¶æ³ã«ãªã£ã¦ã„ã‚‹ãã†ã§ã™ã€‚ã¨ã«ã‹ãã€rAF ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ animation task source ã‹ã‚‰ä¾›çµ¦ã•ã‚Œã‚‹ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚

https://404forest.com/2017/07/18/how-javascript-actually-works-eventloop-and-uirendering/
https://github.com/whatwg/html/issues/2637

ã¤ã¾ã‚Šã€ã€Œ**å˜ä¸€ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ãŸã‚‰ã€ã™ã¹ã¦ã®ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã™ã‚‹**ã€ã¨ã„ã†ã„ã¤ã‚‚ã®ãƒ«ãƒ¼ãƒ«ãŒã“ã“ã§ã‚‚é©ç”¨ã•ã‚Œã¾ã™ã€‚è€ƒãˆæ–¹ã¨ã—ã¦ã¯ã€ã€Œ**Call stack ãŒç©ºã«ãªã£ãŸã‚‰ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒå‡¦ç†ã•ã‚Œã‚‹**ã€ã¨ã„ã†ã‚ˆã†ã«æ‰ãˆãŸæ–¹ãŒã‚ˆã„ç†è§£ã—ã‚„ã™ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã¨ã„ã†ã‚ã‘ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã«ãŠã‘ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã¯æœ€çµ‚çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```js:ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—
// event loop v6
// ç„¡é™ãƒ«ãƒ¼ãƒ—
while (true) {
  // è¤‡æ•°ã‚ã‚‹ Task queue ã‹ã‚‰ï¼‘ã¤ã‚’é¸æŠž
  queue = getNextQueue();
  task = queue.pop();
  execute(task);
  // Task ã¯ï¼‘ã¤ã®ã¿å®Ÿè¡Œã™ã‚‹
  
  // Microtask queue ãŒå®Œå…¨ã«ç©ºã«ãªã‚‹ã¾ã§å‡¦ç†ã™ã‚‹
  while (micortaskQueue.hasTasks()) {
    doMicrotask();
  }

  // å‰ã®æç”»æ›´æ–°ã‹ã‚‰ 16 ãƒŸãƒªç§’ã»ã©çµŒã£ã¦ã„ã‚Œã°å†æç”»(60fps)
  if(isReapintTime()) {
    animationTasks = animationQueue.copyTasks();
    // ç¾æ™‚ç‚¹ã«ãŠã„ã¦ã‚­ãƒ¥ãƒ¼ã«ã‚ã‚‹ã‚‚ã®ã™ã¹ã¦ã‚’å®Ÿè¡Œã™ã‚‹
    // Rendering pipeline ç›´å‰ã«ç¢ºå®Ÿã«å‡¦ç†ã™ã‚‹
    for(task in animationTasks) {
      doAnimationTask(task);
      // Microtask queue ãŒå®Œå…¨ã«ç©ºã«ãªã‚‹ã¾ã§å‡¦ç†ã™ã‚‹
      while (micortaskQueue.hasTasks()) {
        doMicrotask();
      }
    }
    // å†æç”»
    repaint();
  }
}
```

ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã«ã¤ã„ã¦ã¯åˆ†ã‹ã‚Šã¾ã—ãŸãŒã€Node ç’°å¢ƒã§ã¯ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹?

ã€ŽFurther Adventures of the Event Loopã€ã€ã§ã¯ã€ã•ã‚‰ã«ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã‹ã‚‰ node ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¸ã¨ç§»è¡Œã—ã¦è§£èª¬ã—ã¦ãã‚Œã‚‹ã®ã§ã©ã®ã‚ˆã†ã«ãã‚Œãžã‚Œç•°ãªã‚‹ã‹ã¨ã„ã†ç‚¹ãŒã‚¯ãƒªã‚¢ã«ãªã‚Šã¾ã™ã€‚

```js:Node ç’°å¢ƒã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—
// å¾…ã¡çŠ¶æ…‹ã® Task ãŒã‚ã‚‹é™ã‚Šãƒ«ãƒ¼ãƒ—ã™ã‚‹(ãªããªã£ãŸã‚‰æ­¢ã¾ã‚‹)
while (tasksAreWaiting()) {
  queue = getNextQueue();
  // æ¬¡ã® phase (ã‚­ãƒ¥ãƒ¼) ã‚’é¸æŠž

  // å„ phase (ã‚­ãƒ¥ãƒ¼) ã§ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã—ã¦ã„ã‚‹é™ã‚Šã™ã¹ã¦å‡¦ç†ã™ã‚‹
  // å®Ÿã¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯(task)ã®å‡¦ç†å›žæ•°ã®æœ€å¤§æ•°ã«åˆ¶é™ãŒã‚ã‚Šã€ãã‚Œã«åˆ°é”ã™ã‚‹ã¨æ¬¡ã®phaseã«ç§»è¡Œã™ã‚‹
  while (queue.hasTasks()) {
    task = queue.pop();
    execute(task);

    // ï¼‘ã¤ã® Task ã‚’å‡¦ç†ã—ãŸã‚‰ã€ã™ã¹ã¦ã® Micotasks ã‚’å‡¦ç†ã™ã‚‹
    // Microtask queue ã¯ï¼’ã¤å­˜åœ¨ã™ã‚‹ãŒ
    // NextTick queue ã®æ–¹ãŒ promise ã®ã‚­ãƒ¥ãƒ¼ã‚ˆã‚Šã‚‚å…ˆã«å‡¦ç†ã•ã‚Œã‚‹
    while (nextTickQueue.hasTasks()) {
      doNextTickTask();
    }
    while (promiseQueue.hasTasks()) {
      doPromiseTask();
    }
  }
}
```

å®Ÿéš›ã«ã¯ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ Node ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’ç†è§£ã—ãã‚Œãªã„ã®ã§ã€ã‚ã¨ã‹ã‚‰æƒ…å ±ã‚’è£œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

æ¬¡ã®å‹•ç”»ã¯ã€ŽFurther Adventures of the Event Loopã€ã®åˆ¥ã®å ´æ‰€ã§ã®è¬›æ¼”ã®å‹•ç”»ã§ã™ã€‚JSCnof ã®çŸ­ã„æ™‚é–“ã§èªžã‚‰ã‚Œã¦ã„ãŸå†…å®¹ãŒã‚ˆã‚Šè©³ã—ãèªžã‚‰ã‚Œã¦ãŠã‚Šã€ã€ŒAPI ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ç’°å¢ƒã«ã¤ã„ã¦å­¦ã¶ã€ã®é …ç›®ã§è¨˜è¼‰ã—ãŸã‚ˆã†ãªå†…å®¹ã«ã¤ã„ã¦å†’é ­ã§èª¬æ˜Žã•ã‚Œã¦ã„ã‚‹ã®ã§é ­ãŒæ•´ç†ã•ã‚Œã¾ã™ã€‚è¦–è´å›žæ•°ã‚‚éžå¸¸ã«å°‘ãªãã€ã‚ã¾ã‚ŠçŸ¥ã‚‰ã‚Œã¦ã„ãªã„å‹•ç”»ã§ã™ãŒã€**ã“ã®å‹•ç”»ã¯ã‹ãªã‚ŠãŠã™ã™ã‚ã§ã™**ã€‚

@[youtube](2qDNgBgKsXI)

ã“ã®å‹•ç”»ã§ã¯ã€Rendering pipeline ã®ç›´å‰ã«å®Ÿè¡Œã™ã‚‹åˆ¥ã®ã‚¿ã‚¹ã‚¯ã®ãŸã‚ã®ã‚­ãƒ¥ãƒ¼ã¨ã—ã¦ Animation Frame callback queue ã¨ã„ã†ã‚‚ã®å­˜åœ¨ã—ã¦ãŠã‚Šã€ãã®ã‚­ãƒ¥ãƒ¼ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¿ã‚¹ã‚¯ã‚’ç™ºç«ã™ã‚‹ `requestAnimationFrame` ã¨ã„ã† API ãŒã‚ã‚‹ã“ã¨ãŒç†è§£ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è€ƒæ…®ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®ä»•çµ„ã¿ã¨ã€ãã‚Œãžã‚Œã®ã‚¿ã‚¹ã‚¯ãŒé‚è¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã¤ã„ã¦ç´°ã‹ãç†è§£ã§ãã¾ã™ã€‚

é–¢é€£ã—ã¦ã€æ¬¡ã® Mdn ã®è¨˜äº‹ã‚’èª­ã‚“ã§ãŠãã“ã¨ã§ã€å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ Call stack ã¸ã®ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚ç‰¹ã« Global exectution context ã‚’ç†è§£ã™ã‚‹ã“ã¨ã§æœ€åˆã®ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã¤ã„ã¦ç´å¾—ã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã®è¨˜äº‹ã‚’èª­ã‚“ã§ã¿ã¦ã€å€‹äººçš„ã«ã¯ã€**ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚ˆã‚Šã‚‚ã‚¿ã‚¹ã‚¯ã®æ–¹ãŒç†è§£ã®ä¸Šã§é‡è¦ã§ã‚ã‚‹**ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

https://developer.mozilla.org/en-US/docs/Web/API/HTML_DOM_API/Microtask_guide

https://developer.mozilla.org/en-US/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth

ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«ã¤ã„ã¦ã¯æ¬¡ã®è¨˜äº‹ã‚‚ç†è§£ã«å½¹ç«‹ã¡ã¾ã™ã€‚
https://blog.risingstack.com/writing-a-javascript-framework-execution-timing-beyond-settimeout/

JSConf.Asia 2018 ã§ã® Jake Archibald æ°ã®è¬›æ¼”å‹•ç”»ã§ã‚ã‚‹ã€ŽIn The Loopã€ã§ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®è©±ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®è©±ãŒã‚ˆã‚Šè©³ç´°ã«èªžã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ä»–ã®å‹•ç”»ã¨ã¯é•ã£ãŸ Event loop ã®ã‚¤ãƒ¡ãƒ¼ã‚¸(ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«)ã‚’ä½¿ã†ã®ã§é›£æ˜“åº¦ãŒé«˜ã„ã§ã™ã€‚ã€ŽFurther Adventures of the Event Loopã€ã‚’è¦–è´ã—ã¦ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ãŒãšã‚‰ã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ã‹ã‚‰è¦‹ã‚‹ã®ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

@[youtube](cCOL7MC4Pl0)

å¹³å‡ 16.7 ãƒŸãƒªç§’(60 fps) ã®é–“ã« 1 å›žèµ·ãã‚‹ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ›´æ–°ã‚’è€ƒæ…®ã—ãŸä¸Šã§ã‚¿ã‚¹ã‚¯ã‚„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¿ã‚¹ã‚¯ã‚’ã©ã†ã‚„ã£ã¦åˆ¶å¾¡ã™ã‚‹ã‹ã€Task(`setTimeout()`), Microtask(`queueMicrotask()`), animationTask(`requestAnimationFrame()`) ã§ãã‚Œãžã‚Œç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ãŸã¨ãã«ãªã«ãŒãŠã“ã‚‹ã‹ãªã©ãŒç†è§£ã§ãã¾ã™ã€‚

Node ã® Event loop ã«ã¤ã„ã¦ã¯ã€ã€ŽFurther Adventures of the Event Loopã€ã§ã¯å°‘ã—æƒ…å ±ãŒä¸è¶³ã—ã¦ãŠã‚Šã€ã‚ˆã‚Šè§£åƒåº¦ã‚’ã‚ã’ã‚‹ãŸã‚ã«æ¬¡ã®å‹•ç”»ãŒãŠã™ã™ã‚ã§ã™ã€‚

@[youtube](PNa9OMajw9w)

ã“ã®å‹•ç”»ã§ Bert Belder æ°ã«ã‚ˆã£ã¦èª¬æ˜Žã•ã‚Œã¦ã„ã‚‹è³‡æ–™ã¯æœ¬äººãŒå…¬é–‹ã—ã¦ã„ã‚‹æ¬¡ã® Google Drive ä¸Šã‚ã‚‹ PDF ã‹ã‚‰é–²è¦§ã§ãã¾ã™ã€‚Bert Belder æ°ã¯ç¾åœ¨ã¯ Deno ã®é–‹ç™ºã«é–¢ã‚ã£ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã­ã€‚

https://drive.google.com/file/d/0B1ENiZwmJ_J2a09DUmZROV9oSGc/view?resourcekey=0-lR-GaBV1Bmjy086Fp3J4Uw

Node ã«ã¯ãƒ•ã‚§ãƒ¼ã‚ºãŒå­˜åœ¨ã—ã¦ã„ã‚‹ãŸã‚ Event loop ã®å…¨ä½“ã¯ã“ã†ãªã£ã¦ã„ã¾ã™(ä¸Šè¨˜ãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨)ã€‚

![event loop 1](/images/js-async/img_node-event-loop-1.jpg)*å„ãƒ•ã‚§ãƒ¼ã‚ºã‚’å«ã‚€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—å…¨ä½“ (ä¸Šè¨˜ãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨)*

ä¸Šå›³ã§ã®é»„è‰²ã„å°ã•ã„ç®±ãŒã€Call stack ã§å®Ÿè¡Œã•ã‚Œã‚‹ JavaScript ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ãã®é»„è‰²ã„ãƒœãƒƒã‚¯ã‚¹å†…éƒ¨ã«ã¤ã„ã¦æ‹¡å¤§ã—ã¦è¦‹ã¦ã„ã‚‹ã®ãŒä¸‹å›³ã§ã€ãã®å†…éƒ¨ã¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯(ã¤ã¾ã‚Š Task) ã‚’å®Ÿè¡Œã—ãŸå¾Œã«ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’ã‚­ãƒ¥ãƒ¼ãŒå®Œå…¨ã«ç©ºã«ã™ã‚‹ã¾ã§å‡¦ç†ã™ã‚‹ãŸã‚ã®ãƒ«ãƒ¼ãƒ—ã¨ãªã£ã¦ã„ã¾ã™ã€‚

![event loop 2](/images/js-async/img_node-event-loop-2.jpg)*å„ãƒ•ã‚§ãƒ¼ã‚ºã§å˜ä¸€ã‚¿ã‚¹ã‚¯ãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã®ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®å‡¦ç† (ä¸Šè¨˜ãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨)*

ãŸã ã€ã“ã®å‹•ç”»ã¯ 2016/09/25 ã«å…¬é–‹ã•ã‚ŒãŸã®ã‚‚ã®ã§ã™ã€‚å¾“ã£ã¦ã€ã“ã®å‹•ç”»ã§è§£èª¬ã•ã‚Œã¦ã„ã‚‹ Node ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯æœ€å¤§ã§ã‚‚ `6.6.0` ã§ã™ã€‚ã¤ã¾ã‚Šãã®æ™‚ç‚¹ã§ã® Node ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®å…¨ä½“åƒã¨ãªã‚Šã¾ã™ã€‚Node ã¯ v10 ã‹ã‚‰ v11 ã«ãªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯å‡¦ç†ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒãƒ–ãƒ©ã‚¦ã‚¶ã¨åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã™ã‚‹ã¨ã„ã†å¤‰æ›´ãŒã‚ã£ãŸãŸã‚ã€ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨è©±ãŒç•°ãªã£ã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã€ç´¹ä»‹ã—ãŸå›³ã¯ v11 ä»¥ä¸Šã§ãã®ã¾ã¾è§£é‡ˆã™ã‚‹ã¨å¤§ç­‹ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®è§£é‡ˆã¯æ­£ç¢ºã«ã¯ã§ãã¾ã›ã‚“ã€‚

https://github.com/nodejs/node/pull/22842

https://github.com/nodejs/help/issues/3512

v11 æœªæº€ã§ã¯ã€phase ã®ã‚­ãƒ¥ãƒ¼ã«ã‚ã‚‹ã™ã¹ã¦ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã—ã¦ã‹ã‚‰ã€ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’ç©ºã«ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸãŒã€v11 ä»¥ä¸Šã§ã¯å˜ä¸€ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã—ãŸã‚‰ã™ã¹ã¦ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™(ã¤ã¾ã‚Šãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®ä»•æ§˜ã«è¿‘ã¥ãã¾ã—ãŸ)ã€‚

å®Ÿéš›ã€æ¬¡ã®ã‚ˆã†ã« v11 ä»¥ä¸Šã‹æœªæº€ã§å®Ÿè¡Œé †ç•ªãŒç•°ãªã£ã¦ãã¾ã™ã€‚

```js
setTimeout(() => {
  console.log(1);
  Promise.resolve().then(() => {
    console.log(2);
  });
}, 100);
setTimeout(() => {
  console.log(3);
  Promise.resolve().then(() => {
    console.log(4);
  });
}, 100);
// version v11 æœªæº€ã®å‡ºåŠ›é †ç•ª [1 3 2 4]
// version v11 ä»¥ä¸Šã®å‡ºåŠ›é †ç•ª [1 2 3 4]
```

æ¬¡ã® IBM ã®ã‚³ãƒ¼ã‚¹ã®å‹•ç”»ã§ã¯ Node ã® Event loop ã«ã¤ã„ã¦ä»Šã¾ã§è¦‹ãŸã“ã¨ç„¡ã„ãƒ¬ãƒ™ãƒ«ã®è§£åƒåº¦ã§è§£èª¬ã—ã¦ãã‚Œã¦ã„ã¾ã™(é™å®šå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ãŸã‚ URL ã‚’çŸ¥ã‚‰ãªã„ã¨ Youtube ã‹ã‚‰ç›´æŽ¥æ¤œç´¢ã—ã¦ã‚‚ãŸã©ã‚Šç€ãã“ã¨ãŒã§ãã¾ã›ã‚“)ã€‚

@[youtube](X9zVB9WafdE)

Node ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è§£èª¬ã¨åˆã‚ã›ã¦ IBM ã® Node ã«é–¢ã™ã‚‹ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€ã¨ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚

https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#event-loop-explained

https://developer.ibm.com/tutorials/learn-nodejs-the-event-loop/#why-you-need-to-understand-the-event-loop

Node ç’°å¢ƒã§ã¯ã€Phase ã¨ã„ã†ã‚‚ã®ãŒå­˜åœ¨ã—ã¦ãŠã‚Šã€å„ãƒ•ã‚§ãƒ¼ã‚ºã«å¯¾å¿œã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼(ã¾ãŸã¯æº–ãšã‚‹ã‚‚ã®)ãŒã‚ã‚Šã€ä¸€é€£ã® Phase ã‚’ã™ã¹ã¦çµŒéŽã™ã‚‹ã“ã¨ã§ Event loop ã®ä¸€å‘¨ã¨ãªã‚‹ã“ã¨ã‚’ç†è§£ã—ã¾ã™ã€‚

ã“ã¡ã‚‰ã‚‚åˆã‚ã›ã¦èª­ã‚€ã¨ Node ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¸ã®ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚
https://blog.hiroppy.me/entry/nodejs-event-loop

Node ç’°å¢ƒã¯æ­´å²çš„çµŒç·¯ã‹ã‚‰ã€Promise ã®æ©Ÿèƒ½ã‚’å–ã‚Šå…¥ã‚Œã‚‹å‰ã«ã€ã‚‚ã†ï¼‘ã¤ã®ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ã¨ã—ã¦ `nextTickQueue` ã‚’å°Žå…¥ã—ã¦ã„ã¾ã™ã€‚ãã®ã‚­ãƒ¥ãƒ¼ã«ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’ç™ºè¡Œã™ã‚‹ `process.nextTick()` ã¨ã„ã† API ã¯ç¾åœ¨ã§ã¯éžæŽ¨å¥¨ã¨ã¯ã„ã‹ãªã„ã¾ã§ã‚‚ã€ä»£ã‚ã‚Šã«ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãª API ã¨ã—ã¦ `queueMicrotask()` ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«æŽ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€`setTimeout(cb, 0)` ã¨ `setImmediate(cb)` ã®ã‚¿ã‚¤ãƒžãƒ¼å‡¦ç†ã‚’ä¸¦è¡Œã™ã‚‹ã¨å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã£ã¦ã¯éžæ±ºå®šã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã“ã¨ã‚‚ç†è§£ã§ãã¾ã™ã€‚

ã¾ãŸã€æ¬¡ã® Zenn ã§ã®éžåŒæœŸå‡¦ç†ã«ã¤ã„ã¦è¨˜äº‹ã§ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«ã¤ã„ã¦å­¦ã³ã¯ã˜ã‚ãŸã¨ãã«ã¯çŸ¥è­˜ä¸è¶³ã¨ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ãŒæ§‹ç¯‰ãŒã§ãã¦ã„ãªã‹ã£ãŸãŸã‚ã€ç†è§£ã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€ã“ã®æ®µéšŽã«ãªã£ã¦èª­ã¿ç›´ã™ã¨éžå¸¸ã«é ­ãŒã‚¯ãƒªã‚¢ã«ãªã‚Šã¾ã—ãŸ(ä»•æ§˜ã«è¿‘ã™ãŽã¦æœ€åˆç†è§£ã§ãã¾ã›ã‚“ã§ã—ãŸ)ã€‚

https://zenn.dev/qnighy/articles/345aa9cae02d9d

ã“ã®è¨˜äº‹ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã‚’ä»¥å‰ã® node ã®æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã«çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ç”Ÿæˆã•ã‚ŒãŸãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒå®Œå…¨ã«ç©ºã«ãªã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’ã¤ãã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```js:Node ç’°å¢ƒã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—
// å¾…ã¡çŠ¶æ…‹ã® Task ãŒã‚ã‚‹é™ã‚Šãƒ«ãƒ¼ãƒ—ã™ã‚‹(ãªããªã£ãŸã‚‰æ­¢ã¾ã‚‹)
while (tasksAreWaiting()) {
  queue = getNextQueue();
  // æ¬¡ã® phase (ã‚­ãƒ¥ãƒ¼) ã‚’é¸æŠž

  // å„ phase (ã‚­ãƒ¥ãƒ¼) ã§ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã—ã¦ã„ã‚‹é™ã‚Šã™ã¹ã¦å‡¦ç†ã™ã‚‹
  while (queue.hasTasks()) {
    // å®Ÿã¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯(task)ã®å‡¦ç†å›žæ•°ã®æœ€å¤§æ•°(ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜)ã«åˆ¶é™ãŒã‚ã‚Šã€ãã‚Œã«åˆ°é”ã™ã‚‹ã¨æ¬¡ã®phaseã«ç§»è¡Œã™ã‚‹
    if (queue.arriveMaxTasks()) break;
    task = queue.pop();
    execute(task);

    // ï¼‘ã¤ã® Task ã‚’å‡¦ç†ã—ãŸã‚‰ã€ã™ã¹ã¦ã® Micotasks ã‚’å‡¦ç†ã™ã‚‹
    // Microtask queue ã¯ï¼’ã¤å­˜åœ¨ã™ã‚‹ãŒ
    // NextTick queue ã®æ–¹ãŒ promise ã®ã‚­ãƒ¥ãƒ¼ã‚ˆã‚Šã‚‚å…ˆã«å‡¦ç†ã•ã‚Œã‚‹
    do {
      while (nextTickQueue.hasTasks()) {
        doNextTickTask();
      }
      while (promiseQueue.hasTasks()) {
        doPromiseTask();
      }
    } while (nextTickQueue.hasTasks());
    // promiseQueue ã‹ã‚‰æ¥ãŸãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒ process.nextTick ã‚’ä½¿ç”¨ã—ã¦æ–°ã—ã„ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ãŸå ´åˆã‚‚å®Œå…¨ã«ç©ºã«ãªã‚‹ã¾ã§å‡¦ç†ã™ã‚‹
  }
}
```

`nextTickQueue` ã®ãƒ«ãƒ¼ãƒ—ãŒ `promiseQueue` ã®ãƒ«ãƒ¼ãƒ—ã‚’åŒ…ã‚“ã§ã„ã‚‹ã“ã¨ãŒã“ã‚Œã§ç†è§£ã§ãã¾ã™ã€‚

![event loop 2](/images/js-async/img_node-event-loop-2.jpg)

ã¡ãªã¿ã«ã€å‰ã®å›³ä¸­ã«ã‚ã£ãŸãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†æ™‚ `process#exit` ã®åœ°ç‚¹ã«ãŠã„ã¦ã¯ã‚‚ã¯ã‚„ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«æˆ»ã‚‹ã“ã¨ãŒã§ããªã„ã®ã§ã€æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ `proecss.on('exit', callback)` ãŒã‚ã£ãŸéš›ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…éƒ¨ã§åˆ¥ã® task ã‚’ç™ºè¡Œã—ã¦ã‚‚ãã‚Œã‚‰ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã ã‘ã¯å®Ÿè¡Œã§ãã¾ã™ã€‚`socket.on("close", callback)` ãªã©ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ Close callbasks phase ã§å®Ÿè¡Œã•ã‚Œã‚‹ã®ã§ã“ã‚Œã¨å‹˜é•ã„ã—ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

```js
// process ã®çµ‚äº†æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹
process.on("exit", () => {
  console.log("Exit: Process will exit with this code");
  // ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã¯å®Ÿè¡Œã§ãã‚‹ãŒã‚¿ã‚¹ã‚¯ã¯ã‚‚ã¯ã‚„ã“ã®æ®µéšŽã§å®Ÿè¡Œã§ããªã„
  queueMicrotask(() => {
    // ã“ã‚Œã¯å®Ÿè¡Œã§ãã‚‹
    console.log("MICROTASK: by queueMicrotask");
  });

  // ã“ã®æ®µéšŽã§ã¯ãƒ—ãƒ­ã‚»ã‚¹ã®çµ‚äº†ã‚’ã¨ã‚ã‚‹ãŸã‚ã«ã‚¿ã‚¹ã‚¯ã‚’ç™ºè¡Œã—ã¦ã‚‚æ­¢ã‚ã‚‹ã“ã¨ã¯å‡ºæ¥ãªã„
  // ç¢ºå®Ÿã«çµ‚äº†ã™ã‚‹
  setImmediate(() => {
    // ã“ã‚Œã¯å®Ÿè¡Œã•ã‚Œãªã„
    console.log("CHECK phase task: by setImmediate");
  });
  setTimeout(() => {
    // ã“ã‚Œã¯å®Ÿè¡Œã•ã‚Œãªã„
    console.log("TIMERS phase task: by setTimeout");
  });
});
```

Node ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’å®Ÿéš›ã«å®Ÿè£…ã™ã‚‹ã®ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ Libuv (**Unicorn Velociraptor**) ã§ã™ã€‚å¾“ã£ã¦ã€æ¬¡ã® Libuv ã®è§£èª¬å‹•ç”»ã¨åˆã‚ã›ã‚‹ã“ã¨ã§ã€C è¨€èªžã®ã‚³ãƒ¼ãƒ‰ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—å…¨ä½“åƒã‚’ã¤ã‹ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚C ã«ã¤ã„ã¦ã¯è©³ã—ãã‚ã‚Šã¾ã›ã‚“ãŒã€æ¦‚è¦ã¯ã¤ã‹ã‚€ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

@[youtube](sGTRmPiXD4Y)

ã„ã¾ã¾ã§æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã§ç†è§£ã—ã¦ã„ã¾ã—ãŸãŒã€å®Ÿè£…ã¯ã“ã†ãªã£ã¦ã„ã¾ã™ã€‚

```cpp:Node ç’°å¢ƒã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ä¸­å¿ƒéƒ¨
int uv_run(uv_loop_t* loop, uv_run_mode mode) {
  int timeout, r, ran_pending;
  
  r = uv__loop_alive(loop);
  if (r!)
    uv__update_time(loop);
  
  while (r != 0 && loop->stop_flag == 0) {
    uv_update_time(loop);
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—è‡ªä½“ã®æ™‚é–“ã®æ›´æ–°(ã‚¿ã‚¤ãƒžãƒ¼ã¯ã“ã®æ™‚é–“ã¨ã®å·®åˆ†ã‚’å–ã‚‹)
    uv_run_timers(loop); // Timers phase
    ran_pending = uv__run_pending(loop); // Pending I/O callbacks phase
    uv__run_idle(loop); // Idle phase
    uv__run_prepare(loop); // Prepare phase

    timeout = 0;
    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)
      timeout = uv_backend_timeout(loop);
      
    uv_io_poll(loop, timeout); // Poll phase
    uv_run_check(loop); // Check phase
    uv_run_closing_handles(loop); // Close callbacks phase

    if (mode == UV_RUN_ONCE) {
      uv_update_time(loop);
      uv_run_timers(loop);
    }

    // å¾…æ©Ÿä¸­ã® Task ãŒæ®‹ã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ç¢ºèªã™ã‚‹
    r = uv__loop_alive(loop);
    if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)
      break;
  }

  loop->stop_flag = 0;
  
  return r;
}
```

å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒªãƒã‚¸ãƒˆãƒªä¸Šã ã¨ã“ã¡ã‚‰ã«ã‚ã‚Šã¾ã™ã€‚

https://github.com/nodejs/node/blob/c61870c376e2f5b0dbaa939972c46745e21cdbdd/deps/uv/src/unix/core.c#L378-L426

ã¾ãŸã€EventEmitter API ã«ã¤ã„ã¦ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—è‡ªä½“ã¨ã¯ç›´æŽ¥çš„ã«ã¯é–¢ä¿‚ãªãã€ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚ŒãŸçž¬é–“ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚ŒãŸé †ç•ªã§åŒæœŸçš„ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã‚’è¡Œã† `emitter.emit(evnentName)` API è‡ªä½“ãŒãã®ã‚ˆã†ã«åŒæœŸçš„ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’å‘¼ã³å‡ºã™ã¨ã„ã†ã“ã¨ã§ã™ã€‚ 

>**Synchronously calls each of the listeners registered for the event named eventName**, in the order they were registered, passing the supplied arguments to each.
>([Events: emitter.emit(eventName[, ...args]) | Node.js v18.0.0 Documentation](https://nodejs.org/api/events.html#emitteremiteventname-args)ã‚ˆã‚Šå¼•ç”¨)

ã‚‚ã—ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥å¾Œã«éžåŒæœŸçš„ã«ãªã«ã‹ã—ãŸã„ãªã‚‰ã€ãƒªã‚¹ãƒŠãƒ¼ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…éƒ¨ã§ `setTimeout()` ã‚„ `setImmediate()` ãªã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã—ã¦å®Ÿç¾ã§ãã¾ã™ã€‚

>The `EventEmitter` **calls all listeners synchronously in the order in which they were registered**. This ensures the proper sequencing of events and helps avoid race conditions and logic errors. When appropriate, **listener functions can switch to an asynchronous mode of operation using the `setImmediate()` or `process.nextTick()` methods**:
>([Events: Asynchronous vs. synchronous | Node.js v18.0.0 Documentation](https://nodejs.org/api/events.html#asynchronous-vs-synchronous)ã‚ˆã‚Šå¼•ç”¨)

Node ã«ã¤ã„ã¦ã¯ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚

ä¸€æ–¹ã€Deno ç’°å¢ƒã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«ã¤ã„ã¦ã¯ã»ã¨ã‚“ã©æƒ…å ±ãŒãªãå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™(å¤‰æ›´ãŒå¤šã„ã®ã§ã€ã‹ãªã‚Šæ™‚é–“ãŒã‹ã‹ã‚Šãã†)ã€‚Rust ã® Future ã¨ã„ã† Promise ã¨ä¼¼ãŸæ©Ÿèƒ½ã§ Tokio ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ã£ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹ã‚‰ã—ã„ã§ã™ãŒã€ç¾æ™‚ç‚¹ã§ã¯ã‚ã¾ã‚Šæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã©ã†ã‚„ã‚‰ polyfill ã¨ã—ã¦ Node ã® nextTickQueue ã‚‚ä½¿ãˆã‚‹ãŸã‚ã€node ã¨ã®äº’æ›æ€§ã¯å¯èƒ½ãªé™ã‚Šç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ãã†ã§ã™ã€‚

Rust ã§æ›¸ã‹ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®æœ€åˆã® tick ã¯ãƒªãƒã‚¸ãƒˆãƒªä¸Šã§ã¯æ¬¡ã®å ´æ‰€ã«ã‚ã‚Šã¾ã™ã€‚

https://github.com/denoland/deno/blob/main/core/runtime.rs#L842-L990

Dynamic import ã‚„ã‚‰ã€è‰²ã€…æ–°ã—ã„å‡¦ç†ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ãªã‹ãªã‹ç†è§£ã§ãã¾ã›ã‚“ã€‚åŠ ãˆã¦è‰²ã€…ãªå¤‰æ›´ãŒé »ç¹ã«èµ·ã“ã‚‹ãã†ã§ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´å‚™ã¯ã¾ã é›£ã—ã„ã‚‰ã—ã„ã§ã™ã€‚Deno ã«ã¤ã„ã¦ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå…¬é–‹ã•ã‚Œã‚‹ã¾ã§ã¯ã€ç´°ã‹ã„éƒ¨åˆ†ã«ã¤ã„ã¦ã¯å®Ÿè£…ã‚’ã¿ã¦ãªã‚“ã¨ã‹ç†è§£ã™ã‚‹ã—ã‹ãªã„ã¨ã„ã†æ„Ÿã˜ã«ãªã‚Šãã†ã§ã™ã€‚
## ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®å…±é€šæ€§è³ª (è¿½è¨˜)
ã¨ã¯ã„ãˆã€**éžåŒæœŸå‡¦ç†ã‚’äºˆæ¸¬ã™ã‚‹ãŸã‚ã®**ã€ç’°å¢ƒã«ã¨ã‚‰ã‚ã‚Œãªã„ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®å…±é€šæ€§è³ªã¯å­˜åœ¨ã—ã¦ãŠã‚Šã€æ¬¡ã®ã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚

>ã€Œ**Task ï¼‘å›žã®å®Ÿè¡Œã«ã¤ãã€ã™ã¹ã¦ã® Microtask ã‚’å‡¦ç†ã™ã‚‹**ã€

ã“ã®ã‚ˆã†ã«ã‚¿ã‚¹ã‚¯ã¨ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®é–¢ä¿‚æ€§ã‚’æ‰ãˆã‚‹ã“ã¨ã€‚ã“ã‚ŒãŒéžåŒæœŸå‡¦ç†ã‚’äºˆæ¸¬ã™ã‚‹ãŸã‚ã«æœ€ã‚‚é‡è¦ã§ã€ã‹ã¤æœ€çµ‚çš„ãªçµè«–ã¨ãªã‚Šã¾ã™ã€‚

:::message
ã“ã‚ŒãŒéžåŒæœŸå‡¦ç†ã«ãŠã„ã¦ç†è§£ã™ã‚‹ã¹ãçµè«–ã§ã‚ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ã“ã®æœ¬è³ªãŒã¤ã‹ã‚ã‚Œã°ã€ã‚ã¨ã¯ç’°å¢ƒã«ç‰¹æœ‰ãªéžåŒæœŸ API ã®ä½¿ã„æ–¹ã‚„ã€ECMAScript ã«å°Žå…¥ã•ã‚Œã‚‹æ–°ã—ã„éžåŒæœŸå‡¦ç†ã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãªã©ã‚’è¦šãˆã¦ã€ã“ã®ãƒ¢ãƒ‡ãƒ«ã‚’å…ƒã«è€ƒãˆã‚Œã°ã‚ˆã„ã ã‘ã§ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯å…¬é–‹ã—ãŸå¾Œã‹ã‚‰å¤§ããªè¿½è¨˜ã‚’è¿½åŠ ã—ã¦ãã¾ã—ãŸãŒã€ã“ã‚Œä»¥ä¸Šã®æœ¬è³ªçš„ãªéƒ¨åˆ†ã¯ãŠãã‚‰ãã§ã¦ã“ãªã„ã¨æ€ã†ã®ã§ã€ä¿®æ­£ä»¥å¤–ã®æ›´æ–°ã‚’çµ‚ã‚ã‚ŠãŸã„ã¨æ€ã„ã¾ã™ã€‚ã“ã‚Œä»¥ä¸Šã¯ã€æœ¬è³ªã¨ã„ã†ã‚ˆã‚Šã‚‚ã€å˜ç´”ã«åˆ©ç”¨æ™‚ã®å¿œç”¨ã‚„æ³¨æ„ç‚¹ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã—ã€ç´°ã‹ã„éƒ¨åˆ†ã«ã¤ã„ã¦ã¯ Book ã®æ–¹ãªã©ã§æ›¸ã„ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
:::

ã“ã“ã¾ã§ã€ãã‚Œãžã‚Œã®ç’°å¢ƒã§ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®è§£åƒåº¦ã‚’é«˜ã‚ã¾ã—ãŸãŒã€éžåŒæœŸå‡¦ç†ã‚’äºˆæ¸¬ã™ã‚‹ä¸Šã§ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®æœ¬è³ªçš„éƒ¨åˆ†(**ã‚¿ã‚¹ã‚¯ã¨ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®é–¢ä¿‚æ€§**)ã¯åŒã˜ã‚‚ã®ã§ã‚ã‚‹ã¨æƒ³å®šã—ã¾ã™(å®Ÿè£…ãŒãã†ã™ã‚‹ã¨æœŸå¾…ã—ã¾ã™)ã€‚

ã¨ã„ã†ã®ã‚‚ Node ã‚„ Deno ã®ç’°å¢ƒã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®å®Ÿè¡Œãƒ¢ãƒ‡ãƒ«ã«å¯èƒ½ãªé™ã‚Šè¿‘ã¥ã“ã†ã¨ã—ã¦ã„ã‚‹ã“ã¨ãŒ issue ãªã©ã§ã‚ˆã¿ã¨ã‚Œã¾ã™ã€‚ãã—ã¦ã€é‡è¦ãªã“ã¨ã¨ã—ã¦ Chromium, Node, Deno ã¯ã©ã‚Œã‚‚ JavaScript ã® V8 ã‚¨ãƒ³ã‚¸ãƒ³ã‚’æ­è¼‰ã—ã¦ã„ã¾ã™ã€‚

V8 ã‚¨ãƒ³ã‚¸ãƒ³è‡ªä½“ã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè£…ã—ã¾ã›ã‚“ãŒã€**ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ã‚’æ‰€æœ‰ã—ã¦ã„ã¾ã™**ã€‚

https://v8docs.nodesource.com/node-16.13/db/d08/classv8_1_1_microtask_queue.html

Node ã‚„ Deno ã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’ãã‚Œãžã‚Œç•°ãªã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª(Libuv, Tokio)ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ãŒã€**ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ**(ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’ã„ã¤å®Ÿè¡Œã™ã‚‹ã‹)ã«ã¤ã„ã¦ã¯ V8 ã‚’åŸ‹ã‚è¾¼ã‚€å´(Node ã‚„ Deno)ãŒæ±ºã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã‚Œã‚†ãˆã« Node ã§ã¯ `nextTickQueue` ã«ã‚ã‚‹ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’å®Œå…¨ã«å‡¦ç†ã—ã¦ã‹ã‚‰ `microTaskQueue` ã«ã‚ã‚‹ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã™ã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ãŠã‚Šã€v10 ã¨ v11 ã§ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å¤‰æ›´ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã‚Šè¿‘ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—(whatwg ã®ä»•æ§˜)ã«å¤‰æ›´ã§ãã¦ã„ã¾ã™ã€‚

ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¯ã€Œ**Call stack (Execution context stack) ãŒç©ºã«ãªã£ãŸã‚‰**ã€ã¨ã„ã†ã“ã¨ãŒ HTML ä»•æ§˜ã®ã€ŒSpin the event loopã€ã®éƒ¨åˆ†ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒã‚‚ã“ã‚Œã«å¾“ã†ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã€ã¨æƒ³å®šã—ã¾ã™(Event loop ã¯ HTML ä»•æ§˜ã—ã‹å­˜åœ¨ã›ãšã€ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ã JavaScript ã®å†åˆ©ç”¨æ€§ã‚’å¯èƒ½ãªé™ã‚Šé«˜ã‚ã‚‹ãŸã‚)ã€‚

https://html.spec.whatwg.org/multipage/webappapis.html#spin-the-event-loop

![spin the event loop](/images/js-async/img_spin-the-event-loop.jpg)

è©²å½“éƒ¨åˆ†ã€‚
- (4) Empty the JavaScript execution context stack.
- (5) **Perform a microtask checkpoint**.

å¾“ã£ã¦ã€ã‚¿ã‚¹ã‚¯ã¨ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®é–¢ä¿‚æ€§ã¯ V8 ã‚’åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹ã“ã‚Œã‚‰ã®ç’°å¢ƒã§ã¯åŒã˜ã§ã™(åŒã˜ãƒ¢ãƒ‡ãƒ«ã«ãªã‚‹ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã¯ãšã¨æƒ³å®šã—ã¾ã™ã€ãƒã‚°ãªã©ä»¥å¤–ã¯**å®Ÿéš›ãã†ãªã£ã¦ã„ã¾ã™**)ã€‚

https://v8.dev/blog/fast-async#tasks-vs.-microtasks

>On a high level there are tasks and microtasks in JavaScript. Tasks handle events like I/O and timers, and execute one at a time. Microtasks implement deferred execution for async/await and promises, and **execute at the end of each task**. **The microtask queue is always emptied before execution returns to the event loop**.
>(ä¸Šè¨˜ãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨)

ã“ã®å›³ãŒéžåŒæœŸå‡¦ç†ã®å­¦ç¿’ã«ãŠã„ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã§ç†è§£ã™ã¹ãæœ¬è³ªçš„ãªäº‹è±¡ã®å›³ã¨ãªã£ã¦ã„ã¾ã™(ç†è§£ã®ä¸Šã§éžå¸¸ã«é‡è¦ã§ã‚ã‚Šã€éžåŒæœŸå‡¦ç†ã‚’äºˆæ¸¬ã™ã‚‹ãŸã‚ã®ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ã®æ ¸å¿ƒã«ãªã‚Šã¾ã™)ã€‚

![microtasks vs tasks](/images/js-async/img_microtasks-vs-tasks.png)*ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®å…±é€šéƒ¨åˆ†ã¨ã¿ãªã›ã‚‹ (ä¸Šè¨˜ãƒšãƒ¼ã‚¸ã‚ˆã‚Šå¼•ç”¨)*

`setTimeout()` ã‚„  `setImmediate()` ã¯ç’°å¢ƒã®æä¾›ã™ã‚‹éžåŒæœŸ API ã§ã‚ã‚Šã€ãã‚Œã‚‰ã¯ã‚¿ã‚¹ã‚¯ã‚’ç™ºè¡Œã—ã€Promise ã‚„ await ã®å‡¦ç†ã¯ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’ç™ºè¡Œã—ã€**å˜ä¸€ã‚¿ã‚¹ã‚¯ãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã«ã™ã¹ã¦ã®ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã—ã¾ã™**ã€‚ã“ã‚Œã‚’åˆ¥ã®è¨€ã„æ–¹ã§è¨€ã†ã¨ã€Œ**ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ãŒç©ºã«ãªã£ãŸã‚‰ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã™ã‚‹**ã€ã¨ãªã‚Šã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã¨ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒã®å¤§ããªé•ã„ã¯**ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ä½œæ¥­ãŒã‚ã‚‹ã‹ãªã„ã‹**ã§ã™ã€‚

:::message
Node ç’°å¢ƒã§ã¯ Promise ãŒå…¥ã‚‹å‰ã«ã‚¿ã‚¹ã‚¯ã‚’ç™ºè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ™ãƒ¼ã‚¹(ã‚¤ãƒ™ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹)ã® API ã‚’åŸºæœ¬ã¨ã—ã¦é–‹ç™ºã—ãŸã“ã¨ã‚‚ã‚ã£ã¦ã€ãã‚Œã‚‰ã‹ã‚‰ç™ºè¡Œã•ã‚Œã‚‹ã‚¿ã‚¹ã‚¯ã‚’ä»•åˆ†ã‘ã‚‹è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ã«ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ã‚’è¨­ã‘ã‚‹ãŸã‚ã« Phase æ¦‚å¿µã‚’å°Žå…¥ã—ãŸã¨è€ƒãˆã‚‰ã‚Œã¾ã™(å€‹äººçš„ãªæŽ¨æ¸¬ã§ã™)ã€‚

Deno ç’°å¢ƒã§ã¯ã‚¿ã‚¤ãƒžãƒ¼ä»¥å¤–ã¯ Promise based ãª API ã‚’åŸºæœ¬ã¨ã—ãŸãŸã‚ã« Node ã® Phase ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã¯å®Ÿè³ª Timers ã®ã¿ã¨ãªã£ã¦ã„ã¾ã™(ã“ã‚Œã«ã¤ã„ã¦ã¯ Discord ã®ãƒ˜ãƒ«ãƒ—ã§ã‚³ãƒŸãƒƒã‚¿ãƒ¼ã«èžãã¾ã—ãŸ)ã€‚

ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã‚‚ Web API ã§ Promise ã‚’è¿”ã•ãªã„éžåŒæœŸ API (ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ¸¡ã—ã¦ã‚¿ã‚¹ã‚¯ã®ã¿ã‚’ç™ºè¡Œã™ã‚‹ã‚¿ã‚¤ãƒ—)ã¯å¤ã„ã‚¿ã‚¤ãƒ—ã® API ã§ã‚ã‚‹ã¨ã„ã†ã“ã¨ãŒç¤ºå”†ã•ã‚Œã¦ã„ã¾ã™ã€‚

>**ç†æƒ³çš„ã«ã¯ã€ã™ã¹ã¦ã®éžåŒæœŸé–¢æ•°ã¯ãƒ—ãƒ­ãƒŸã‚¹ã‚’è¿”ã™ã¯ãšã§ã™ãŒã€æ®‹å¿µãªãŒã‚‰ API ã®ä¸­ã«ã¯ã„ã¾ã ã«å¤ã„ã‚„ã‚Šæ–¹ã§æˆåŠŸ/å¤±æ•—ç”¨ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ¸¡ã—ã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã™**ã€‚é¡•è‘—ãªä¾‹ã¨ã—ã¦ã¯ `setTimeout()` é–¢æ•°ãŒã‚ã‚Šã¾ã™ã€‚
>([ãƒ—ãƒ­ãƒŸã‚¹ã®ä½¿ç”¨ - JavaScript | MDN](https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Using_promises#%E5%8F%A4%E3%81%84%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF_api_%E3%82%92%E3%83%A9%E3%83%83%E3%83%97%E3%81%99%E3%82%8B_promise_%E3%81%AE%E4%BD%9C%E6%88%90) ã‚ˆã‚Šå¼•ç”¨)

`FileReader.readAsText()` ãªã©ã® Web API ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ãªã®ã§ã€ã‚ˆã‚Šæ–°ã—ã„ Promise-based API ã¨ã—ã¦ `Blob.text()` ãªã©ãŒç™»å ´ã—ã¦ãã¦ã„ã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/API/Blob/text

å®Ÿã¯ Node ã§ã‚‚ Promise-based ãª API ã‚’æä¾›ã—ã¯ã˜ã‚ã¦ãŠã‚Šã€Promise based ãª Timer API (Promise ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ `setTimeout()`, `setImmediate()`, `setInterval()`) ãªã©ã‚‚å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚

https://nodejs.org/api/timers.html#timers-promises-api

ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’ç™ºè¡Œã™ã‚‹ Promise ã®ä»•çµ„ã¿ãŒéžåŒæœŸå‡¦ç†ã®è¦ã«ãªã£ã¦ãã‚‹(ã¨ã„ã†ã‹ã€ã‚‚ã†ãªã£ã¦ã‚‹?)ã“ã¨ã¯é–“é•ã„ç„¡ã•ãã†ã§ã™ã€‚ãŸã ã—ã€ãã‚Œã¯ã‚¿ã‚¹ã‚¯ãŒãªããªã‚‹ã¨ã„ã†ã“ã¨ã‚’æ„å‘³ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`<script>` ã‚¿ã‚°ãªã©ã®è©•ä¾¡ã¯ã‚¿ã‚¹ã‚¯ã§ã™ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚‚ãªããªã‚Šã¾ã›ã‚“ã€‚
:::

# ãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—ã®ã¾ã¨ã‚

ãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—ã®ã¾ã¨ã‚ã€‚
- (0) éžåŒæœŸå‡¦ç†ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«æš—é»™çš„ã«å¿…è¦ã¨ã•ã‚Œã‚‹ ECMAScript ã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚’å­¦ã¶
- (1) Promise ã‚„ async/await ã¨ã„ã£ãŸ ECMAScript ã®æ©Ÿèƒ½ã«ã¤ã„ã¦ç†è§£ã™ã‚‹
- (2) Promise ãƒã‚§ãƒ¼ãƒ³ã®æ§‹ç¯‰ã¨ await å¼ã¨ã®é–¢ä¿‚æ€§ã«ã¤ã„ã¦å­¦ã¶
- (3) ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®æ¦‚è¦ã¨ã‚¿ã‚¹ã‚¯/ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦å­¦ã¶
- (4) éžåŒæœŸ API ã‚’æä¾›ã™ã‚‹ç’°å¢ƒã«ã¤ã„ã¦å­¦ã¶
- (5) (ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®è§£åƒåº¦ã‚’ä¸Šã’ã¦ã€å„ç’°å¢ƒã§ã®æŒ¯ã‚‹èˆžã„ã«ã¤ã„ã¦å­¦ã¶)
- (6) ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®æœ¬è³ªçš„ãªéƒ¨åˆ†ã‚’æ‰ãˆã‚‹

å¾ŒåŠã® (4) ã‹ã‚‰ã¯å˜ç´”ã«è‡ªåˆ†ã®å­¦ç¿’æ™‚ç³»åˆ—ã«ãªã£ã¦ã„ã‚‹ã ã‘ãªã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã•ã¦ã€ãµã‚Šã‹ãˆã£ã¦ã¿ã‚‹ã¨æ¬¡ã®ï¼“ç‚¹ãŒé‡è¦ã§ã—ãŸã€‚

(A) è¨€èªžæ©Ÿèƒ½ã§ã‚ã‚‹ Promise ã¨ async/awit ã®é–¢ä¿‚ã‚’ã—ã£ã‹ã‚ŠæŠŠæ¡ã—ã€Promise ãƒã‚§ãƒ¼ãƒ³ã‚„ await å¼ã§å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ãŒåˆ†å‰²ã•ã‚Œã¦åˆ¶å¾¡ãŒè¡Œã£ãŸã‚Šæ¥ãŸã‚Šã—ã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ãã“ã¨ãŒé‡è¦ã§ã™ã€‚ã€ŒåŒæœŸã€ã‚„ã€ŒéžåŒæœŸã€ã¨ã„ã†è¨€è‘‰ã«æƒ‘ã‚ã•ã‚Œãšã«ã€ã€Œ**ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°**ã€ã¨ã€Œ**é€æ¬¡çš„ãªå®Ÿè¡Œ**ã€ã§è€ƒãˆã¾ã™ã€‚

(B) ç’°å¢ƒã¨çµ¡ã‚ãŸéžåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿ã®ç†è§£ã¨ã€ãã®ç›®çš„ã®è§£é‡ˆã‚‚é‡è¦ã§ã™ã€‚
ã€Œç’°å¢ƒãŒæä¾›ã™ã‚‹æ©Ÿèƒ½ã§ã‚ã‚‹ API ã‚’ä»‹ã—ã¦æ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†ã‚’ç’°å¢ƒã«å§”ä»»ã—ã€ãã‚ŒãŒå®Œäº†ã—ãŸã‚‰ JavaScript ã®ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã«ãã®å‡¦ç†çµæžœã¨ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã¨å…±ã«é€šçŸ¥ã•ã›ã¦ãã®ä½œæ¥­ã«é–¢é€£ã™ã‚‹ä½•ã‹åˆ¥ã®ä½œæ¥­ã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å½¢ã§è¡Œã†ã€ã¨ã„ã†ã®ãŒéžåŒæœŸå‡¦ç†ã®å…¨ä½“çš„ãªä»•çµ„ã¿ã§ã‚ã‚Šã€ã€Œç’°å¢ƒãŒä¸¦åˆ—çš„ã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä½œæ¥­ã—ã¦ã„ã‚‹é–“ã‚‚ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§åˆ¥ã®ä½œæ¥­ã‚’ç¶šã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã€ãŒéžåŒæœŸå‡¦ç†ã®å¤§ããªç›®çš„ã¨ãªã‚Šã¾ã™ã€‚

(C) ãã—ã¦éžåŒæœŸå‡¦ç†ã‚’äºˆæ¸¬ã™ã‚‹ãŸã‚ã®æ¦‚å¿µã¨å‡¦ç†ã®ãƒ¢ãƒ‡ãƒ«ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚
**ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®ä¸­ã§ã‚¿ã‚¹ã‚¯ã¨ãƒžã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®ãƒ¢ãƒ‡ãƒ«ãŒé ­ã®ä¸­ã§å®Œæˆã™ã‚‹ã“ã¨**ãŒéžå¸¸ã«é‡è¦ã§ã™ã€‚ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®è§£åƒåº¦ã‚’ã‚ã’ã‚‹ãŸã‚ã«ã¯è‰²ã€…å¿…è¦ãªæƒ…å ±ãŒå¤šã„ã§ã™ãŒã€æœ¬è³ªçš„ãªéƒ¨åˆ†ã¯éžå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‚Šã€ã‚ã‚‰ã‚†ã‚‹ç’°å¢ƒã§å…±é€šã§ã‚ã‚‹ã¨æœŸå¾…ã§ãã¾ã™(ã“ã‚ŒãŒåˆ†ã‹ã‚‹ãŸã‚ã«è‰²ã€…ãªæƒ…å ±ãŒå¿…è¦ã ã£ãŸã‚ã‘ã§ã™ãŒ)ã€‚

éžåŒæœŸå‡¦ç†ã®å­¦ç¿’ã‚’ã™ã‚‹éš›ã«ã¯ã“ã‚Œã‚‰ã®ç‚¹ã«æ°—ã‚’ã¤ã‘ã‚‹ã¨ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ãã‚‹ã¨æ€ã†ã®ã§ã€å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã‚ã¨ã€Œå­¦ç¿’å‰äºˆæƒ³æ™‚ã®ï¼”å€ã¯é›£ã—ã„ã€ã¨ã„ã†ã“ã¨ãŒã‚ãªãŒã¡å˜˜ã§ã‚‚ãªã„ã“ã¨ãŒåˆ†ã‹ã£ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãªã‚‹ã¹ãã€ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã—ã¦ãã ã•ã„ðŸ˜…

# å‚è€ƒæ–‡çŒ®ã¨ãƒ„ãƒ¼ãƒ«ã®ã¾ã¨ã‚

éžåŒæœŸå‡¦ç†ã‚’ç†è§£ã™ã‚‹ã®ã«å¿…è¦ä¸å¯æ¬ ãªé“å…·ã€‚
- [Loupe](http://latentflip.com/loupe/)
- [JS Visualizer 9000](https://www.jsv9000.app)
- ã™ãã« JS ã‚’å®Ÿè¡Œã§ãã‚‹ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒ(Deno or Node)

éžåŒæœŸå‡¦ç†ã®åŸºç¤Žã‚’ç†è§£ã™ã‚‹ãŸã‚ã«å¿…è¦ãªåŸºæœ¬ãƒªã‚½ãƒ¼ã‚¹ã€‚
- [JavaScript Primer - è¿·ã‚ãªã„ãŸã‚ã®å…¥é–€æ›¸](https://jsprimer.net/)
- [What the heck is the event loop anyway? | Philip Roberts | JSConf EU - YouTube](https://www.youtube.com/watch?v=8aGhZQkoFbQ&t=804s)
- [mdn](https://developer.mozilla.org/ja/docs/Learn/JavaScript/Asynchronous)

åˆ†ã‹ã£ã¦ããŸã¨æ€ã£ãŸã“ã‚ã«åˆ†ã‹ã£ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã®ã«å½¹ç«‹ã£ãŸãƒªã‚½ãƒ¼ã‚¹ã€‚
- [JavaScriptã®async/await ç†è§£ã—ã¦ã¾ã™ã‹ï¼Ÿ èª¬æ˜Žã§ãã¾ã™ã‹ï¼Ÿ ã‚¯ã‚¤ã‚ºã«ç­”ãˆã¦ã‚‚ã‚‰ã£ã¦è‰¯ã„ã§ã™ã‹ï¼Ÿ - YouTube](https://www.youtube.com/watch?v=T-_0Pc5P12U&t=36s)

ã‚ã‚‹ç¨‹åº¦è‡ªä¿¡ã‚’æŒã£ã¦ç†è§£ã—ãŸã¨è¨€ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹ã€‚
- [JavaScript Promiseã®æœ¬](https://azu.github.io/promises-book/)ã®ã‚³ãƒ©ãƒ 
- [We have a problem with promises](https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html)
- [mdn](https://developer.mozilla.org/ja/docs/Learn/JavaScript/Asynchronous)(åˆæ­©ã«ã—ã¦çœŸé«„çš„ãªã¨ã“ãŒã‚ã‚‹)

ç’°å¢ƒã«ãŠã‘ã‚‹éžåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ç†è§£ã™ã‚‹ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹ã€‚
- [Inside look at modern web browser (part 2) - Chrome Developers](https://developer.chrome.com/blog/inside-browser-part2/)
- [Angular Basics: Introduction to Processes, Threadsâ€”Web UI](https://www.telerik.com/blogs/angular-basics-introduction-processes-threads-web-ui-developers)
- [What the heck is the event loop anyway? | Philip Roberts | JSConf EU - YouTube](https://www.youtube.com/watch?v=8aGhZQkoFbQ&t=804s)

ç¾ä»£ã®éžåŒæœŸå‡¦ç†ã®æ©Ÿèƒ½ã‚’ä¿¯çž°ã™ã‚‹ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹ã€‚
- [Asynchrony: Under the Hood - Shelley Vohr - JSConf EU - YouTube](https://www.youtube.com/watch?v=SrNQS8J67zc)
- [JavaScript Primer - è¿·ã‚ãªã„ãŸã‚ã®å…¥é–€æ›¸](https://jsprimer.net/)

ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®è§£åƒåº¦ã‚’ä¸Šã’ã¦å…±é€šæ€§è³ªã‚’æ‰ãˆã‚‹ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹(å¤šã„ã®ã§æœ€ã‚‚ã‚ªã‚¹ã‚¹ãƒ¡ã—ãŸã„ã‚‚ã®ã ã‘)ã€‚
- [YOW! Perth 2018 - Erin Zimmer - Adventures with the JavaScript Event Loop #YOW!Perth - YouTube](https://www.youtube.com/watch?v=2qDNgBgKsXI&list=TLGGeQ1PY_e4jiIyOTA0MjAyMg): ã¨ã¦ã‚‚ãƒãƒ©ãƒ³ã‚¹ãŒã‚ˆãã€å®Ÿéš›ã“ã‚ŒãŒä¸€ç•ªæœ¬è³ªçš„ãªéƒ¨åˆ†ã‚’ã¨ã‚‰ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸ
- [JavaScriptã®éžåŒæœŸå‡¦ç†ã‚’ã˜ã£ãã‚Šç†è§£ã™ã‚‹ (1) å®Ÿè¡Œãƒ¢ãƒ‡ãƒ«ã¨ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼](https://zenn.dev/qnighy/articles/345aa9cae02d9d): ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ãŒå‡ºæ¥ä¸ŠãŒã£ã¦ã‹ã‚‰èª­ã‚€ã¨éžå¸¸ã«é ­ãŒã‚¯ãƒªã‚¢ã«ãªã‚Šã¾ã™

